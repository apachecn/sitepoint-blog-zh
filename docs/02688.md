# æ¯”è¾ƒ Rails:æ¢ç´¢å‡¤å‡°åŸçš„ WebSockets

> åŸæ–‡:[https://www . site point . com/comparising-rails-exploring-web sockets-in-phoenix/](https://www.sitepoint.com/comparing-rails-exploring-websockets-in-phoenix/)

Rails 5 æœ€å¤§çš„ç‰¹æ€§ä¹‹ä¸€å°±æ˜¯ WebSocketsã€‚çœ‹èµ·æ¥è¿™ä¸ªç‰¹æ€§åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å—äº†å‡¤å‡°ç½‘çš„å¯å‘ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Elixir å’Œ Phoenix åˆ›å»ºå®æ—¶ Twitter æµçƒ­å›¾ã€‚

è¿™ä¸ªæƒ³æ³•æ˜¯æŒ‚é’©åˆ° Twitter æ ·æœ¬æµï¼Œå¹¶åœ¨ä¸–ç•Œåœ°å›¾ä¸Šç»˜åˆ¶æ¨æ–‡ã€‚æˆ‘ä¸ä¼šè®¨è®ºå®‰è£…è¯´æ˜ï¼Œå› ä¸ºå‡¤å‡°å®˜æ–¹æŒ‡å—åšå¾—æ›´å¥½ã€‚

è¿™å°±æ˜¯æˆ‘ä»¬è¿½æ±‚çš„ç›®æ ‡:

[https://www.youtube.com/embed/17iIX0-fleY](https://www.youtube.com/embed/17iIX0-fleY)

## å»ºç«‹å‡¤å‡°è®¡åˆ’

æˆ‘ä»¬å¼€å§‹å§ï¼é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ Phoenix é¡¹ç›®:

```
% mix phoenix.new heetweet && cd heetweet 
```

ä¸ºäº†ç¡®ä¿ä¸€åˆ‡è®¾ç½®æ­£ç¡®ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€`http://localhost:4000`ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°é»˜è®¤çš„ Phoenix é¡µé¢:

![](../Images/fe0a21dcf4afd1a0ece663ec65640357.png)

ä¸ºäº†ä¸ Twitter API é€šä¿¡ï¼Œæˆ‘ä»¬å¿…é¡»å®‰è£…ä¸€ä¸ª Twitter å®¢æˆ·ç«¯åº“ [ExTwitter](https://github.com/parroty/extwitter) ã€‚

æˆ‘ä»¬å°†åœ¨`mix.exs`ä¸­æŒ‡å®šè¿™ç§ä¾èµ–æ€§ï¼Œç›¸å½“äº Rails çš„`Gemfile`ã€‚å®šä½`deps`åŠŸèƒ½ï¼Œå¢åŠ `ExTwitter`å’Œ`OAuth`ï¼Œå‰è€…ä¾èµ–äº:

```
defmodule Heetweet.Mixfile do
  use Mix.Project

  # ...

  defp deps do
    [{:phoenix, "~> 1.1.4"},
     {:postgrex, ">= 0.0.0"},
     {:phoenix_ecto, "~> 2.0"},
     {:phoenix_html, "~> 2.4"},
     {:phoenix_live_reload, "~> 1.0", only: :dev},
     {:gettext, "~> 0.9"},
     {:cowboy, "~> 1.0"},
     {:oauth, github: "tim/erlang-oauth"},
     {:extwitter, "~> 0.7.1"}]
  end

end 
```

> äºŒéƒå’Œä»™ä¸¹å¯ä»¥æ„‰å¿«åœ°äº’æ“ä½œï¼
> 
> æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°`OAuth`æ˜¯ä¸€ä¸ª *Erlang* åº“ï¼Œç„¶è€Œ ExTwitter ä¾èµ–äºå®ƒã€‚äº‹å®è¯æ˜ï¼ŒElixir å’Œ Erlang å¯ä»¥æ„‰å¿«åœ°äº’æ“ä½œã€‚è¿™æ„å‘³ç€ä¸¤ç§è¯­è¨€çš„åº“éƒ½å¯ä»¥åœ¨ä»»ä¸€ç§è¯­è¨€ä¸­ä½¿ç”¨ã€‚

æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦å‘Šè¯‰ Phoenix å¯åŠ¨ ExTwitter *åº”ç”¨ç¨‹åº*ã€‚Elixir ä¸­çš„åº”ç”¨ç¨‹åºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº“ï¼Œå¯ä»¥è¢«å…¶ä»–åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚äº‹å®ä¸Šï¼Œ`deps`å‡½æ•°ä¸­æŒ‡å®šçš„è®¸å¤šä¾èµ–é¡¹éƒ½æ˜¯åº”ç”¨ç¨‹åºã€‚

ä½ å¯èƒ½å¬è¯´è¿‡è¯å‰‚/Erlang ä¸­çš„ç›‘ç£æ ‘ã€‚åº”ç”¨ç¨‹åºå¯ä»¥æ‰“åŒ…æˆè‡ªå·±çš„ç®¡ç†æ ‘ï¼Œå½“å‡ºç°é—®é¢˜æ—¶å¯ä»¥*è‡ªæˆ‘ä¿®å¤*ã€‚

çœ‹çœ‹åŒä¸€ä¸ª`mix.exs`æ–‡ä»¶ä¸­æŒ‡å®šçš„`applications`å‡½æ•°:

```
defmodule Heetweet.Mixfile do
  use Mix.Project

  # ...

  def application do
    [mod: {Heetweet, []},
     applications:[:phoenix, :phoenix_html, :cowboy, :logger, :gettext,
                    :phoenix_ecto, :postgrex]]
  end

end 
```

æˆ‘ä»¬éœ€è¦å°† ExTwitter æ·»åŠ åˆ°`applications`åˆ—è¡¨ä¸­:

```
def application do
  [mod: {Heetweet, []},
   applications:[:phoenix, :phoenix_html, :cowboy, :logger, :gettext,
                  :phoenix_ecto, :postgrex, :extwitter]]
end 
```

## è®¾ç½® Twitter

åœ¨ä½¿ç”¨ ExTwitter ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å‰å¾€`https://apps.twitter.com/`ï¼Œç™»å½•å¹¶ç‚¹å‡»â€œåˆ›å»ºæ–°åº”ç”¨â€ã€‚

è¿™æ˜¯æˆ‘å¡«çš„:

*   **å§“å** : Heetweet
*   **æè¿°** : Heetweet åœ¨çƒ­å›¾ä¸Šæ˜¾ç¤ºæ¨æ–‡
*   **ç½‘ç«™**:http://www.example.com

> æ³¨æ„:æ‚¨å¿…é¡»åœ¨â€œæ‰‹æœºâ€ä¸‹çš„ä¸ªäººèµ„æ–™éƒ¨åˆ†æä¾›æ‚¨çš„æ‰‹æœºå·ç ã€‚

å®Œæˆè¿™äº›æ­¥éª¤åï¼Œæ‚¨å°†å¯ä»¥è®¿é—®åŒ…å«æ¶ˆè´¹è€…å¯†é’¥å’Œå¯†ç ä»¥åŠè®¿é—®ä»¤ç‰Œå’Œè®¿é—®ä»¤ç‰Œå¯†ç çš„é¡µé¢:

![](../Images/524b3109cc6606b57b02547a9d60b496.png)

æˆ‘ä»¬éœ€è¦å°†è¿™äº›æ·»åŠ åˆ°`config/config.exs`ä¸­ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°æ–‡ä»¶çš„åº•éƒ¨:

```
config :extwitter, :oauth, [
  consumer_key: System.get_env("TWITTER_CONSUMER_KEY"),
  consumer_secret: System.get_env("TWITTER_CONSUMER_SECRET"),
  access_token: System.get_env("TWITTER_ACCESS_TOKEN"),
  access_token_secret: System.get_env("TWITTER_ACCESS_SECRET")
] 
```

å½“ç„¶ï¼Œæ‚¨æ°¸è¿œä¸ä¼šå¸Œæœ›ä»¥çº¯æ–‡æœ¬çš„å½¢å¼å­˜å‚¨æ•æ„Ÿçš„å‡­æ®ï¼Œå¹¶å°†å®ƒä»¬æäº¤ç»™æºä»£ç æ§åˆ¶ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦åœ¨`~/.bashrc`æˆ–ç±»ä¼¼çš„åœ°æ–¹æŒ‡å®šè¿™äº›å†…å®¹(å–å†³äºæ‚¨çš„ shell):

```
export TWITTER_CONSUMER_KEY="xxxxxxxxxxxxxxxxxxxxxxxxx"
export TWITTER_CONSUMER_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
export TWITTER_ACCESS_TOKEN="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
export TWITTER_ACCESS_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
```

ä¸€æ—¦å®Œæˆï¼Œç¡®ä¿ä½ æˆ–è€…æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯çª—å£æˆ–è€…æ‰‹åŠ¨è¿è¡Œ`source ~/.bashrc`(æˆ–è€…ç­‰æ•ˆçš„ï¼Œå–å†³äºä½ çš„ shell)ã€‚

## å¸¦ç€è²å°¼å…‹æ–¯å…œé£

è®©æˆ‘ä»¬ç¡®ä¿ä¸€åˆ‡éƒ½è®¾ç½®æ­£ç¡®ã€‚æˆ‘ä»¬å°†æ‰“å¼€ REPL è¯å‰‚(read-eval-print-loop ),è®©å®ƒåƒè¿™æ ·åŠ è½½æˆ‘ä»¬çš„ Phoenix åº”ç”¨ç¨‹åº:

```
% iex -S mix phoenix.server 
```

è®©æˆ‘ä»¬é€šè¿‡è¿è¡Œä¸€ä¸ªæŸ¥è¯¢æ¥æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦æ­£ç¡®åœ°é…ç½®äº† ExTwitterï¼Œè¿™ä¸ªæŸ¥è¯¢å¯ä»¥ä¿è¯å¾—åˆ°ç»“æœ:

```
iex> ExTwitter.search("bieber", [count: 5]) \
|> Enum.map(fn(tweet) -> tweet.text end) \
|> Enum.join("\n---\n") \
|> IO.puts 
```

> æ³¨æ„:å¦‚æœä½ è¦å¤åˆ¶ç²˜è´´ä¸Šé¢çš„ä»£ç ç‰‡æ®µï¼Œè¯·é€è¡Œç²˜è´´*è€Œä¸æ˜¯æ•´ä¸ªä»£ç å—ã€‚*

è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ®µä»£ç åšäº†ä»€ä¹ˆã€‚ç¬¬ä¸€è¡Œæœç´¢â€œbieber â€,æœ€å¤šæœ‰äº”ä¸ªç»“æœã€‚ç»“æœä»¥ä¸€åˆ—`ExTwitter.Model.Tweet`è¿”å›ã€‚å› ä¸ºæˆ‘ä»¬åªå¯¹æ¨æ–‡çš„å†…å®¹æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿è¡Œ`Enum.map`å‡½æ•°æ¥æå–æ¯æ¡æ¨æ–‡çš„`text`ã€‚æ¯æ¡æ¨æ–‡çš„å†…éƒ¨è¡¨ç¤ºå¦‚ä¸‹:

```
%ExTwitter.Model.Tweet{id: 724195286688645120,
  lang: "en",
  user: %ExTwitter.Model.User{contributors_enabled: false,
   id: 714513423896342530,
   screen_name: "asloveme4", lang: "pl", name: "ohai",
   url: "https://t.co/A8YqMw5YPh",
   description: "@justinbieber So take my hand and walk with me,\n Show me what to be,\n I need you to set me free",
   profile_image_url: "http://pbs.twimg.com/profile_images/722497035136413696/4xAxtZvN_normal.jpg",
   statuses_count: 1186, friends_count: 177, favourites_count: 80,
   show_all_inline_media: nil, utc_offset: nil, followers_count: 93,
   profile_banner_url: "https://pbs.twimg.com/profile_banners/714513423896342530/1460233025",
   default_profile_image: false, following: false, location: "Poland",
   protected: false,
   profile_background_image_url_https: "https://abs.twimg.com/images/themes/theme1/bg.png",
  quoted_status: nil,
  text: "RT @hot_or_not_pll: #43 Justin Bieber\nRT- hot ğŸ”¥ğŸ”¥\nFav- not ğŸ‘ğŸ‘ https://t.co/3IpoxYL6qZ",
  entities: %{hashtags: [],
    media: [%{display_url: "pic.twitter.com/3IpoxYL6qZ",
       expanded_url: "http://twitter.com/hot_or_not_pll/status/723558996532187137/photo/1",
    user_mentions: [%{id: 723238093705367552, id_str: "723238093705367552",
, favorite_count: 28, favorited: false, geo: nil} 
```

è¯·æ³¨æ„ï¼Œ`Tweet`æ¨¡å‹æœ‰ä¸€ä¸ªå¯¹åº”çš„`%ExTwitter.Model.User`æ¨¡å‹ã€‚è¿™å°†æœ‰åŠ©äºæˆ‘ä»¬ç¡®å®šç”¨æˆ·çš„å›½å®¶ã€‚

## è®¾ç½®åœ°å›¾

æˆ‘ä»¬å°†ä½¿ç”¨[ä¼ å•](http://leafletjs.com/)ï¼Œä¸€ä¸ª Javascript åº“ï¼Œè®©æˆ‘ä»¬æ‹¥æœ‰äº¤äº’å¼åœ°å›¾ã€‚æ‰“å¼€`web/templates/layout/app.html.eex`ã€‚æˆ‘ä»¬å°†æ¸…é™¤å¤§éƒ¨åˆ† HTMLï¼Œæ·»åŠ ä¼ å•æ‰€éœ€çš„ CSS å’Œ Javascriptã€‚ç»“æœå¦‚ä¸‹:

```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Hello Heetweet!</title>
    <link rel="stylesheet" href="<%= static_path(@conn, "/css/app.css") %>">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  </head>

  <body>
    <%= render @view_module, @view_template, assigns %>
    <script src="<%= static_path(@conn, "/js/app.js") %>"></script>
  </body>
</html> 
```

## è®¾ç½®çƒ­å›¾åº“

å¹¸è¿çš„æ˜¯ï¼Œfleet é™„å¸¦äº†ä¸€ä¸ªæ–¹ä¾¿çš„çƒ­å›¾åº“ï¼Œåä¸º[fleet . heat](https://github.com/Leaflet/Leaflet.heat)ã€‚

æˆ‘ç®€å•åœ°ä¸‹è½½äº†[åº“](https://raw.githubusercontent.com/Leaflet/Leaflet.heat/gh-pages/dist/leaflet-heat.js)ï¼Œå¹¶å°†æ–‡ä»¶æ”¾å…¥`web/static/vendor`ã€‚

## websocket

è®©æˆ‘ä»¬æ¥çœ‹çœ‹ç½‘ç»œæ’åº§å§ï¼é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¯ç”¨ Phoenix ä¸­ WebSockets çš„å®¢æˆ·ç«¯éƒ¨åˆ†ã€‚æ‰“å¼€`app.js`ï¼Œå–æ¶ˆå¯¹ä»¥ä¸‹è¡Œçš„æ³¨é‡Š:

```
import socket from "./socket" 
```

ç°åœ¨å‰å¾€`web/static/js/socket.js`ã€‚å¯¼èˆªåˆ°æ–‡ä»¶çš„åº•éƒ¨:

```
let channel = socket.channel("tweets:lobby", {})
channel.join()
  .receive("ok", resp => { console.log("Joined successfully", resp) })
  .receive("error", resp => { console.log("Unable to join", resp) }) 
```

æˆ‘ä»¬åŸºæœ¬ä¸ŠæŒ‡å®šæˆ‘ä»¬å¸Œæœ›å¥—æ¥å­—é€šè¿‡ä¸€ä¸ªé€šé“è¿æ¥åˆ°â€œtweets:lobbyâ€ä¸»é¢˜ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†åŸå°ä¸åŠ¨åœ°ç¦»å¼€ã€‚

## è®¾ç½®é¢‘é“åç«¯

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‡¤å‡°é¢‘é“ã€‚å‡¤å‡°å·ä¸ºæ­¤é…å¤‡äº†ä¸€ä¸ªæ–¹ä¾¿çš„å‘ç”µæœº:

```
% mix phoenix.gen.channel Room tweets
* creating web/channels/room_channel.ex
* creating test/channels/room_channel_test.exs

Add the channel to your `web/channels/user_socket.ex` handler, for example:

    channel "tweets:lobby", Heetweet.RoomChannel 
```

è®©æˆ‘ä»¬å¬ä»ç”Ÿæˆå™¨çš„å»ºè®®ï¼Œå°†é€šé“æ·»åŠ åˆ°`user_socket.ex`:

```
defmodule Heetweet.UserSocket do
  use Phoenix.Socket

  channel "tweets:lobby", Heetweet.RoomChannel

  # ...
end 
```

å½“ä½ æ‰“å¼€ Phoenix åº”ç”¨ç¨‹åºæ—¶ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ°

```
Joined successfully Object {} 
```

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ã€‚å¦‚æœæ‚¨å·²ç»åˆ°è¾¾è¿™ä¸ªé˜¶æ®µï¼Œé‚£ä¹ˆæ‚¨å·²ç»æˆåŠŸåœ°åœ¨ Phoenix ä¸­è¿æ¥äº† WebSocketsã€‚ç°åœ¨å¼€å§‹æœ‰è¶£çš„äº‹æƒ…ï¼

## å°†æ‰€æœ‰ä¸œè¥¿è¿æ¥åœ¨ä¸€èµ·

ç°åœ¨æµè§ˆå™¨å¯ä»¥æˆåŠŸè¿æ¥åˆ°åç«¯äº†ï¼Œæ¥ä¸‹æ¥å‘¢ï¼Ÿå—¯ï¼Œæˆ‘ä»¬éœ€è¦å‘æˆ‘ä»¬çš„åç«¯å‘å‡ºä¿¡å·ï¼Œå®ƒå¯ä»¥å¼€å§‹å‘æˆ‘ä»¬å‘é€æ•°æ®ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†`start_stream`æ¨å…¥é€šé“:

```
channel.join()
    .receive("ok", resp => {
        console.log("Joined successfully", resp)
        channel.push("start_stream", {})   // <---
    })
    .receive("error", resp => { console.log("Unable to join", resp) }) 
```

ç„¶åæˆ‘ä»¬éœ€è¦åœ¨åç«¯å¤„ç†`start_stream`æ¶ˆæ¯ã€‚å‰å¾€`web/channels/room_channel.ex`ã€‚å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»ä½¿ç”¨`mix phoenix.channel`ç”Ÿæˆå™¨åˆ›å»ºäº†å®ƒã€‚ç¥å¥‡çš„äº‹æƒ…å‘ç”Ÿåœ¨è¿™ä¸ªå‡½æ•°ä¸­:

```
defmodule Heetweet.RoomChannel do
  use Heetweet.Web, :channel

  # ...

 def handle_in("start_stream", payload, socket) do
    stream = ExTwitter.stream_filter(locations: ['-180,-90,180,90'])
    |> Stream.map(fn x -> x.coordinates end)

    # Twitter gives us coordinates in reverse order (long first, then lat)
    for %{coordinates: [lng, lat]} <- stream do
      push socket, "new_tweet", %{lat: lat, lng: lng}
    end

    {:reply, {:ok, payload}, socket}
  end

  # ...
end 
```

æˆ‘ä»¬åœ¨è¿™é‡Œåšäº†å¾ˆå¤šï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ‰“å¼€åŒ…è£…ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»è·å¾—åŒ…å«åæ ‡çš„ tweets æµã€‚æˆ‘ä»¬æƒ³è¦è¦†ç›–å…¨çƒçš„æ¨æ–‡ï¼ŒExTwitter åº“æœ‰è¿™æ ·ä¸€ä¸ªåŠŸèƒ½:

```
ExTwitter.stream_filter(locations: ['-180,-90,180,90']) 
```

è¿™é‡Œæœ‰ä¸€ä¸ªçµä¸¹å¦™è¯:ä¸Šé¢çš„å‡½æ•°è¿”å›ä¸€ä¸ª*æµ*ã€‚åœ¨ Ruby ä¸­ï¼Œè¿™ç±»ä¼¼äºæƒ°æ€§å¯æšä¸¾ã€‚åœ¨æˆ‘ä»¬æ˜ç¡®è¯·æ±‚å®ƒä¹‹å‰ï¼Œå®ƒä¸ä¼šå‘å‡ºä»»ä½•å€¼ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é“¾æ¥å…¶ä»–æµæ“ä½œæ¥æ“ä½œæ¯ä¸ªå‘å‡ºçš„å€¼ï¼Œå®ƒ*ä»ç„¶*ä¸ä¼šè¿”å›ä»»ä½•å€¼ã€‚å› æ­¤ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•ä»æ¨æ–‡ä¸­äº§ç”Ÿä¸€ä¸²*åæ ‡*:

```
stream = ExTwitter.stream_filter(locations: ['-180,-90,180,90'])
         |> Stream.map(fn x -> x.coordinates end) 
```

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ *`for`ç†è§£*æ¥è¿­ä»£åæ ‡æµ(å¯èƒ½æ˜¯æ— é™çš„)ã€‚è™½ç„¶è¿™é‡Œçš„`for`ç†è§£çœ‹èµ·æ¥åƒä¸€ä¸ªæ™®é€šçš„`for`å¾ªç¯ï¼Œä½†å®é™…ä¸Šå¹¶ä¸åƒçœ‹ä¸Šå»é‚£æ ·ç®€å•ã€‚é•¿ç”Ÿä¸è€è¯`for`çš„ç†è§£æœ‰åŠ©äºä¸¢å¼ƒæ— æ•ˆçš„å€¼ã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºæœ‰äº›æ¨æ–‡æ²¡æœ‰åæ ‡ã€‚åœ¨`for`ç†è§£çš„ä¸»ä½“å†…ï¼Œæˆ‘ä»¬å¯ä»¥å°†åæ ‡æ¨å‡ºåˆ°è¿æ¥çš„å¥—æ¥å­—:

```
for %{coordinates: [lng, lat]} <- stream do
  push socket, "new_tweet", %{lat: lat, lng: lng}
end 
```

ç°åœ¨å›åˆ°å®¢æˆ·ç«¯ã€‚æ‰“å¼€`web/static/js/socket.js`ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬é¦–å…ˆè®¾ç½®åœ°å›¾å¹¶æ·»åŠ ä¸€ä¸ªç©ºçš„çƒ­ç‚¹å›¾å›¾å±‚:

```
var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
}).addTo(map);

var heat = L.heatLayer([]).addTo(map); 
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†`new_tweet`å’Œå®ƒçš„æœ‰æ•ˆè½½è·(åæ ‡):

```
channel.on("new_tweet", payload => {
    // artificially add more points to get the heatmap effect
    for (var i = 0; i < 100; i++) {
        heat.addLatLng([payload.lat, payload.lng])
    }
}) 
```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé’ˆå¯¹ç»™å®šåæ ‡å‘çƒ­ç‚¹å›¾å›¾å±‚æ·»åŠ åæ ‡ä¸€ç™¾æ¬¡çš„å¾ªç¯ã€‚åŸå› æ˜¯æˆ‘å¤ªæ‡’äº†ï¼Œä¸æƒ³çœ‹åˆ°æ¼‚äº®çš„çƒ­å›¾æ•ˆæœï¼Œä¸ºäº†å³æ—¶çš„æ»¡è¶³æ„Ÿï¼Œæˆ‘å†³å®šåŠ å¿«ä¸€ç‚¹é€Ÿåº¦ã€‚

å°±æ˜¯è¿™æ ·ï¼ä»¥ä¸‹æ˜¯ Heetweet çš„å…¨ç››æ—¶æœŸ:

[https://www.youtube.com/embed/17iIX0-fleY](https://www.youtube.com/embed/17iIX0-fleY)

## æ‘˜è¦

æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå­¦åˆ°äº†ä¸€äº›æ–°ä¸œè¥¿ï¼æˆ‘é¼“åŠ±æ‚¨å°è¯•ä¸€ä¸‹ Phoenixï¼Œå°¤å…¶æ˜¯å¦‚æœæ‚¨ä¸€ç›´æ¸´æœ›å°è¯• WebSockets çš„è¯ã€‚

## åˆ†äº«è¿™ç¯‡æ–‡ç« 