# ä½¿ç”¨ TypeScriptã€Prisma å’Œ Next.js æ„å»ºä¸€ä¸ª Twitter å…‹éš†

> åŸæ–‡:[https://www.sitepoint.com/nextjs-prisma-twitter-clone/](https://www.sitepoint.com/nextjs-prisma-twitter-clone/)

å­¦ä¹  React è¿™æ ·çš„å·¥å…·çš„æœ€å¥½æ–¹æ³•æ˜¯ç”¨å®ƒæ¥æ„å»ºä¸€äº›ä¸œè¥¿ã€‚ [Next.js](https://nextjs.org/) æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œå¸®åŠ©ä½ ä¸ºç”Ÿäº§è€Œæ„å»ºã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ [Next.js](https://nextjs.org/) å’Œ [Prisma](https://www.prisma.io/) æ„å»º Twitter çš„å…‹éš†ã€‚

æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†å…·æœ‰ä»¥ä¸‹åŠŸèƒ½:

*   ä½¿ç”¨ [NextAuth](https://next-auth.js.org/) å’Œ Twitter OAuth è¿›è¡Œè®¤è¯
*   æ·»åŠ æ–°æ¨æ–‡çš„é€‰é¡¹
*   æŸ¥çœ‹æ¨æ–‡åˆ—è¡¨çš„é€‰é¡¹
*   ä¸€ä¸ªé€‰é¡¹ï¼ŒæŸ¥çœ‹ç”¨æˆ·çš„ä¸ªäººèµ„æ–™ï¼Œåªæœ‰ä»–ä»¬çš„æ¨æ–‡

æˆ‘ä»¬å°†è¦æ„å»ºçš„åº”ç”¨ç¨‹åºçš„ä»£ç å¯ä»¥åœ¨ [GitHub](https://github.com/sitepoint-editors/twitter-clone-using-nextjs-and-prisma) ä¸Šè·å¾—ã€‚æˆ‘ä»¬å°†ä½¿ç”¨[æ‰“å­—ç¨¿](https://www.sitepoint.com/typescript-tutorial-for-beginners/)æ¥æ„å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

## é¢„èµ›

[Next.js](https://nextjs.org/) æ˜¯æœ€æµè¡Œçš„ [React.js](https://reactjs.org/) æ¡†æ¶ä¹‹ä¸€ã€‚å®ƒæœ‰å¾ˆå¤šç‰¹æ€§ï¼Œæ¯”å¦‚æœåŠ¡å™¨ç«¯æ¸²æŸ“ã€[ç±»å‹è„šæœ¬æ”¯æŒ](https://nextjs.org/docs/basic-features/typescript)ã€[å›¾åƒä¼˜åŒ–](https://nextjs.org/docs/basic-features/image-optimization)ã€ [I18n æ”¯æŒ](https://nextjs.org/docs/advanced-features/i18n-routing)ã€[æ–‡ä»¶ç³»ç»Ÿè·¯ç”±](https://nextjs.org/docs/routing/introduction)ç­‰ç­‰ã€‚

Prisma æ˜¯ Node.js å’Œ TypeScript çš„ä¸€ä¸ª [ORM](https://stackoverflow.com/questions/1279613/what-is-an-orm-how-does-it-work-and-how-should-i-use-one) ã€‚å®ƒè¿˜æä¾›äº†è®¸å¤šç‰¹æ€§ï¼Œå¦‚åŸå§‹æ•°æ®åº“è®¿é—®ã€æ— ç¼å…³ç³» APIã€åŸç”Ÿæ•°æ®åº“ç±»å‹ç­‰ç­‰ã€‚

### æ‰€éœ€è½¯ä»¶

ä¸ºäº†è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä»¥ä¸‹è½¯ä»¶:

*   [ç å¤´å·¥äºº](https://docs.docker.com/get-docker/)
*   [npm](https://nodejs.org/en/download/)
*   [çº±çº¿](https://classic.yarnpkg.com/en/docs/install/)
*   [å»](https://git-scm.com/downloads)

è¿™äº›æŠ€æœ¯å°†åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨:

*   [Next.js](https://nextjs.org/) :ç”¨äºæ„å»ºæˆ‘ä»¬çš„åº”ç”¨
*   [Prisma](https://www.prisma.io/) :ç”¨äºå°†æ•°æ®æå–å¹¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­
*   [Chakra UI](http://chakra-ui.com/) :ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ·»åŠ é£æ ¼
*   [NextAuth](https://next-auth.js.org/) :ç”¨äºå¤„ç†è®¤è¯
*   [React Query](https://react-query.tanstack.com/) :ç”¨äºè·å–å’Œæ›´æ–°æˆ‘ä»¬åº”ç”¨ä¸­çš„æ•°æ®

## åˆ›å»ºæ–°çš„ Next.js åº”ç”¨ç¨‹åº

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼æˆ‘ä»¬å°†é¦–å…ˆé€šè¿‡ä»ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Next.js åº”ç”¨ç¨‹åº:

```
yarn create next-app 
```

å½“å‘½ä»¤æç¤ºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦è¾“å…¥åº”ç”¨ç¨‹åºçš„åç§°ã€‚æˆ‘ä»¬å¯ä»¥ç»™å®ƒèµ·ä»»ä½•æˆ‘ä»¬æƒ³è¦çš„åå­—ã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å°†æŠŠå®ƒå‘½åä¸º **twitter-clone** ã€‚æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿåœ¨ç»ˆç«¯ä¸Šçœ‹åˆ°ç±»ä¼¼çš„è¾“å‡º:

```
$ yarn create next-app

yarn create v1.22.5
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
[4/4] ğŸ”¨  Building fresh packages...

success Installed "create-next-app@10.0.4" with binaries:
      - create-next-app
âœ” What is your project named? twitter-clone
Creating a new Next.js app in /twitter-clone.

....

Initialized a git repository.

Success! Created twitter-clone at /twitter-clone
Inside that directory, you can run several commands:

  yarn dev
    Starts the development server.

  yarn build
    Builds the app for production.

  yarn start
    Runs the built app in production mode.

We suggest that you begin by typing:

  cd twitter-clone
  yarn dev 
```

æˆ‘ä»¬ç°åœ¨å¯ä»¥è¿›å…¥ **twitter-clone** ç›®å½•ï¼Œé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº:

```
cd twitter-clone && yarn dev 
```

æˆ‘ä»¬çš„ Next.js åº”ç”¨ç¨‹åºåº”è¯¥åœ¨ [http://localhost:3000](http://localhost:3000/) ä¸Šå¯åŠ¨å¹¶è¿è¡Œã€‚æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ä»¥ä¸‹å±å¹•:

![Next.js app running on localhost:3000](../Images/77c1dec25362fcb48fca947c07f00b5d.png)

## æ·»åŠ  Dockerized PostgreSQL æ•°æ®åº“

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ª[Dockerized](https://hub.docker.com/_/postgres)[PostgreSQL](https://www.postgresql.org/)æ•°æ®åº“ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·å’Œæ¨æ–‡ä¿å­˜åˆ°å…¶ä¸­ã€‚æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„`docker-compose.yml`æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
version: "3"

services:
  db:
    container_name: db
    image: postgres:11.3-alpine
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  db_data: 
```

å¦‚æœ Docker æ­£åœ¨æˆ‘ä»¬çš„æœºå™¨ä¸Šè¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä»åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨ PostgreSQL å®¹å™¨:

```
docker-compose up 
```

ä¸Šé¢çš„å‘½ä»¤å°†å¯åŠ¨ PostgreSQL å®¹å™¨ï¼Œå¹¶ä¸”å¯ä»¥åœ¨`postgresql://postgres:@localhost:5432/postgres`è®¿é—®å®ƒã€‚æ³¨æ„ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Postgres çš„[æœ¬åœ°å®‰è£…æ¥ä»£æ›¿ Dockerizedã€‚](https://www.postgresql.org/download/)

## æ·»åŠ  Chakra UI

[Chakra UI](https://chakra-ui.com/) æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ React.js ç»„ä»¶åº“ã€‚å®ƒéå¸¸å—æ¬¢è¿ï¼Œå…·æœ‰å¯è®¿é—®æ€§ã€æ”¯æŒæ˜æš—æ¨¡å¼ç­‰ç‰¹æ€§ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Chakra UI æ¥è®¾è®¡æˆ‘ä»¬çš„ç”¨æˆ·ç•Œé¢ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»åº”ç”¨ç¨‹åºæ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…è¯¥è½¯ä»¶åŒ…:

```
yarn add @chakra-ui/react @emotion/react @emotion/styled framer-motion 
```

è®©æˆ‘ä»¬åœ¨`pages`ç›®å½•ä¸­å°†`_app.js`æ–‡ä»¶é‡å‘½åä¸º`_app.tsx`,å¹¶ç”¨ä»¥ä¸‹å†…å®¹æ›¿æ¢å®ƒçš„å†…å®¹:

```
// pages/_app.tsx

import { ChakraProvider } from "@chakra-ui/react";
import { AppProps } from "next/app";
import Head from "next/head";
import React from "react";

const App = ({ Component, pageProps }: AppProps) => {
  return (
    <>
      <Head>
        <link rel="shortcut icon" href="/images/favicon.ico" />
      </Head>
      <ChakraProvider>
        <Component {...pageProps} />
      </ChakraProvider>
    </>
  );
};

export default App; 
```

å› ä¸ºæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ TypeScript æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡å¯ Next.js æœåŠ¡å™¨ã€‚ä¸€æ—¦æˆ‘ä»¬é‡æ–°å¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä»¥ä¸‹é”™è¯¯:

```
$ yarn dev

yarn run v1.22.5
$ next dev
ready - started server on http://localhost:3000
It looks like you're trying to use TypeScript but do not have the required package(s) installed.

Please install typescript, @types/react, and @types/node by running:

  yarn add --dev typescript @types/react @types/node

If you are not trying to use TypeScript, please remove the tsconfig.json file from your package root (and any TypeScript files in your pages directory). 
```

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ TypeScript æ–‡ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰æ·»åŠ è¿è¡Œå®ƒä»¬æ‰€å¿…éœ€çš„ä¾èµ–é¡¹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®‰è£…ç¼ºå¤±çš„ä¾èµ–é¡¹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä»æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…ç¼ºå°‘çš„ä¾èµ–é¡¹:

```
yarn add --dev typescript @types/react @types/node 
```

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å¯åŠ¨ Next.js æœåŠ¡å™¨ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåº”è¯¥ç¼–è¯‘ä¸º:

```
$ yarn dev

yarn run v1.22.5
$ next dev
ready - started server on http://localhost:3000
We detected TypeScript in your project and created a tsconfig.json file for you.

event - compiled successfully 
```

## æ·»åŠ  NextAuth

[NextAuth](https://next-auth.js.org/) æ˜¯ Next.js çš„è®¤è¯åº“ï¼Œç®€å•æ˜“æ‡‚ï¼Œé»˜è®¤æƒ…å†µä¸‹çµæ´»å®‰å…¨ã€‚è¦åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­è®¾ç½® NextAuthï¼Œæˆ‘ä»¬éœ€è¦ä»åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å®ƒ:

```
yarn add next-auth 
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¿…é¡»ç”¨ä»¥ä¸‹å†…å®¹æ›´æ–°æˆ‘ä»¬çš„`pages/_app.tsx`æ–‡ä»¶:

```
// pages/_app.tsx

import { ChakraProvider } from "@chakra-ui/react";
import { Provider as NextAuthProvider } from "next-auth/client";
import { AppProps } from "next/app";
import Head from "next/head";
import React from "react";

const App = ({ Component, pageProps }: AppProps) => {
  return (
    <>
      <Head>
        <link rel="shortcut icon" href="/images/favicon.ico" />
      </Head>
      <NextAuthProvider session={pageProps.session}>
        <ChakraProvider>
          <Component {...pageProps} />
        </ChakraProvider>
      </NextAuthProvider>
    </>
  );
};

export default App; 
```

è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨`NextAuthProvider`åŒ…è£…æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨`pages/api/auth`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`[...nextauth].ts`çš„æ–°æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
// pages/api/auth/[...nextauth].ts

import { NextApiRequest, NextApiResponse } from "next";
import NextAuth from "next-auth";
import Providers from "next-auth/providers";

const options = {
  providers: [
    Providers.Twitter({
      clientId: process.env.TWITTER_KEY,
      clientSecret: process.env.TWITTER_SECRET,
    }),
  ],
};

export default NextAuth(options); 
```

ä¸Šé¢çš„æ–‡ä»¶å°†è´Ÿè´£ä½¿ç”¨ [Next.js API routes](https://nextjs.org/docs/api-routes/introduction) å¤„ç†æˆ‘ä»¬çš„è®¤è¯ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`.env`çš„æ–°å­—æ®µï¼Œç”¨ä»¥ä¸‹å†…å®¹å­˜å‚¨æ‰€æœ‰ç¯å¢ƒå˜é‡:

```
DATABASE_URL="postgresql://postgres:@localhost:5432/postgres?synchronize=true"
NEXTAUTH_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:3000
TWITTER_KEY=""
TWITTER_SECRET="" 
```

Twitter ç¯å¢ƒå˜é‡å°†ä» [Twitter API](https://developer.twitter.com/en/portal/dashboard) ä¸­ç”Ÿæˆã€‚æˆ‘ä»¬æ¥ä¸‹æ¥ä¼šè¿™ä¹ˆåšã€‚æˆ‘ä»¬å¯ä»¥ä» [Twitter å¼€å‘è€…ä»ªè¡¨æ¿](https://developer.twitter.com/en/portal/apps/new)åˆ›å»ºä¸€ä¸ªæ–°çš„ Twitter åº”ç”¨ã€‚

1.  è¾“å…¥åç§°åˆ›å»ºä¸€ä¸ªæ–°çš„ Twitter åº”ç”¨ç¨‹åºï¼Œç„¶åç‚¹å‡»**å®Œæˆ**æŒ‰é’®ã€‚

    ![Create a new Twitter app](../Images/db5df6bd7de4dc635a60bd259c9347df.png)

2.  åœ¨ä¸‹ä¸€å±å¤åˆ¶ **API å¯†é’¥**ã€ **API å¯†é’¥**å’Œ**ä¸è®°åä»¤ç‰Œ**ã€‚

    ![The credentials of our Twitter app](../Images/bb06707cdf3a552cbe161fc42d4acb39.png)

3.  åœ¨ä¸‹ä¸€ä¸ªå±å¹•ä¸­ï¼Œå°† **App æƒé™**ä»**åªè¯»**æ›´æ”¹ä¸º**è¯»å†™**ã€‚

    ![Twitter app permissions](../Images/0e17cb583ab07b27346fa4c4ad7e7ef7.png)

4.  ç‚¹å‡»**è®¤è¯è®¾ç½®**æ—è¾¹çš„**ç¼–è¾‘**æŒ‰é’®ï¼Œå¯ç”¨**ä¸‰è„šè®¤è¯**ã€‚

    ![Authentication settings for our Twitter app](../Images/f9188487d05abaafb79258cc0b1d90af.png)

5.  å¯ç”¨**ä¸‰è„š OAuth** å’Œ**å‘ç”¨æˆ·**è¯·æ±‚ç”µå­é‚®ä»¶åœ°å€ï¼Œå¹¶æ·»åŠ [http://localhost:3000/API/auth/Callback/Twitter](http://localhost:3000/api/auth/callback/twitter)ä½œä¸º**å›è°ƒ URL** ã€‚

    ![Edit the authentication settings of our Twitter app](../Images/3ecfdef8494f64066cdcfdeb3cf7ee3c.png)

6.  **ç½‘å€**ã€**æœåŠ¡æ¡æ¬¾**å’Œ**éšç§æ”¿ç­–**æ–‡ä»¶å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿(åˆ†åˆ«ä¸º`https://yourwebsite.com`ã€`https://yourwebsite.com/terms`ã€`https://yourwebsite.com/privacy`)ã€‚

æˆ‘ä»¬çš„ä¸‰æ¡è…¿ OAuth ç°åœ¨åº”è¯¥å¯ç”¨äº†ã€‚

![Enable the 3-legged OAuth of our Twitter app](../Images/612d2a1b91485c2e92c99e1d01f9080f.png)

å°†æ¥è‡ª**æ­¥éª¤ 2** çš„ **API å¯†é’¥**çš„å€¼ç²˜è´´åˆ° **TWITTER_KEY** ç¯å¢ƒå˜é‡ä¸­ï¼Œå¹¶å°† **API ç§˜å¯†å¯†é’¥**çš„å€¼ç²˜è´´åˆ° **TWITTER_SECRET** ç¯å¢ƒå˜é‡ä¸­ã€‚

æˆ‘ä»¬çš„`.env`æ–‡ä»¶ç°åœ¨åº”è¯¥æ˜¯è¿™æ ·çš„:

```
DATABASE_URL="postgresql://postgres:@localhost:5432/postgres"
NEXTAUTH_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:3000
TWITTER_KEY="1234" // Replace this with your own API key
TWITTER_SECRET="secret" // Replaces this with your own API secret key 
```

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬é‡å¯ Next.js æœåŠ¡å™¨å¹¶è®¿é—®[http://localhost:3000/API/auth/Sign in](http://localhost:3000/api/auth/signin)ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°**ç”¨ Twitter** æŒ‰é’®ç™»å½•:

![Sign in with Twitter button](../Images/c37e0dcc8e345e665051785f8e07f62f.png)

å¦‚æœæˆ‘ä»¬ç‚¹å‡»è¯¥æŒ‰é’®ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿæˆæƒæˆ‘ä»¬çš„ Twitter åº”ç”¨ç¨‹åºï¼Œä½†æˆ‘ä»¬å°†æ— æ³•ç™»å½•æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬çš„ç»ˆç«¯å°†æ˜¾ç¤ºä»¥ä¸‹é”™è¯¯:

```
[next-auth][warn][jwt_auto_generated_signing_key]
https://next-auth.js.org/warnings#jwt_auto_generated_signing_key 
```

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€æ¬¡æ·»åŠ å’Œé…ç½® Prisma æ—¶è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## æ·»åŠ å’Œé…ç½® Prisma

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…æ‰€æœ‰å¿…è¦çš„ä¾èµ–é¡¹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®ç°è¿™ä¸€ç‚¹:

```
yarn add prisma @prisma/client 
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åœ¨`lib/clients`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`prisma.ts`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// lib/clients/prisma.ts

import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

export default prisma; 
```

è¿™ä¸ª`PrismaClient`å°†åœ¨å¤šä¸ªæ–‡ä»¶ä¸­é‡å¤ä½¿ç”¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¿…é¡»ç”¨ä»¥ä¸‹å†…å®¹æ›´æ–°æˆ‘ä»¬çš„`pages/api/auth/[...nextauth].ts`æ–‡ä»¶:

```
....

import prisma from "../../../lib/clients/prisma";
import Adapters from "next-auth/adapters";

....

const options = {
  providers: [
    ....
  ],
  adapter: Adapters.Prisma.Adapter({ prisma }),
};

.... 
```

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è®¿é—®[http://localhost:3000/API/auth/sign in](http://localhost:3000/api/auth/signin)ï¼Œæˆ‘ä»¬å°†åœ¨ç»ˆç«¯ä¸Šå¾—åˆ°ä»¥ä¸‹é”™è¯¯:

```
Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again. 
```

è¦è§£å†³æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

1.  ä»æˆ‘ä»¬åº”ç”¨çš„æ ¹ç›®å½•è¿è¡Œ`npx prisma init`:

```
 $ npx prisma init

   Environment variables loaded from .env

   âœ” Your Prisma schema was created at prisma/schema.prisma.
     You can now open it in your favorite editor.

   warn Prisma would have added DATABASE_URL="postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public" but it already exists in .env

   Next steps:
   1. Set the DATABASE_URL in the .env file to point to your existing database. If your database has no tables yet, read https://pris.ly/d/getting-started.
   2. Set the provider of the datasource block in schema.prisma to match your database: postgresql, mysql or sqlite.
   3. Run prisma introspect to turn your database schema into a Prisma data model.
   4. Run prisma generate to install Prisma Client. You can then start querying your database.

   More information in our documentation:
   https://pris.ly/d/getting-started 
```

2.  ä»æˆ‘ä»¬åº”ç”¨çš„æ ¹ç›®å½•è¿è¡Œ`npx prisma generate`:

```
 $ npx prisma generate
                               4s
   Environment variables loaded from .env
   Prisma schema loaded from prisma/schema.prisma
   Error:
   You don't have any models defined in your schema.prisma, so nothing will be generated.
   You can define a model like this:

   model User {
     id    Int     @id @default(autoincrement())
     email String  @unique
     name  String?
   }

   More information in our documentation:
   https://pris.ly/d/prisma-schema 
```

3.  ç”¨ [NextAuth æœŸæœ›](https://next-auth.js.org/schemas/adapters#prisma-schema)çš„æ¨¡å¼æ›´æ–°`prisma/schema.prisma`æ–‡ä»¶:

```
 // prisma/schema.prisma

   generator client {
     provider = "prisma-client-js"
   }

   datasource db {
     provider = "postgresql"
     url      = env("DATABASE_URL")
   }

   model Account {
     id                 Int       @id @default(autoincrement())
     compoundId         String    @unique @map("compound_id")
     userId             Int       @map("user_id")
     providerType       String    @map("provider_type")
     providerId         String    @map("provider_id")
     providerAccountId  String    @map("provider_account_id")
     refreshToken       String?   @map("refresh_token")
     accessToken        String?   @map("access_token")
     accessTokenExpires DateTime? @map("access_token_expires")
     createdAt          DateTime  @default(now()) @map("created_at")
     updatedAt          DateTime  @default(now()) @map("updated_at")

     @@index([providerAccountId], name: "providerAccountId")
     @@index([providerId], name: "providerId")
     @@index([userId], name: "userId")
     @@map("accounts")
   }

   model Session {
     id           Int      @id @default(autoincrement())
     userId       Int      @map("user_id")
     expires      DateTime
     sessionToken String   @unique @map("session_token")
     accessToken  String   @unique @map("access_token")
     createdAt    DateTime @default(now()) @map("created_at")
     updatedAt    DateTime @default(now()) @map("updated_at")

     @@map("sessions")
   }

   model User {
     id            Int       @id @default(autoincrement())
     name          String?
     email         String?   @unique
     emailVerified DateTime? @map("email_verified")
     image         String?
     createdAt     DateTime  @default(now()) @map("created_at")
     updatedAt     DateTime  @default(now()) @map("updated_at")
     tweets        Tweet[]

     @@map("users")
   }

   model VerificationRequest {
     id         Int      @id @default(autoincrement())
     identifier String
     token      String   @unique
     expires    DateTime
     createdAt  DateTime @default(now()) @map("created_at")
     updatedAt  DateTime @default(now()) @map("updated_at")

     @@map("verification_requests")
   } 
```

4.  åœ¨`prisma/schema.prisma`æ–‡ä»¶ä¸­æ·»åŠ  Tweet çš„æ¨¡å¼:

```
 // prisma/schema.prisma

   ....

   model Tweet {
     id        Int      @id @default(autoincrement())
     body      String
     userId    Int
     createdAt DateTime @default(now()) @map("created_at")
     updatedAt DateTime @default(now()) @map("updated_at")
     author    User     @relation(fields: [userId], references: [id])

     @@map("tweets")
   } 
```

5.  ä»æˆ‘ä»¬åº”ç”¨çš„æ ¹ç›®å½•è¿è¡Œ`npx prisma migrate dev --preview-feature`åˆ°[åˆ›å»ºä¸€ä¸ªæ–°çš„è¿ç§»](https://www.prisma.io/docs/guides/prisma-guides/prisma-migrate-guides/add-prisma-migrate-to-a-project)ã€‚å‡ºç°æç¤ºæ—¶ï¼Œè¾“å…¥è¿ç§»çš„åç§°(å¦‚ **init-database** )ã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è®¿é—®[http://localhost:3000/API/auth/Sign in](http://localhost:3000/api/auth/signin)å¹¶ç‚¹å‡»**ç”¨ Twitter ç™»å½•**æŒ‰é’®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Twitter ç™»å½•æˆ‘ä»¬çš„åº”ç”¨ã€‚

## æ·»åŠ ä¸€äº›ç§å­æ•°æ®

å› æ­¤ï¼Œå½“æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸Šå·¥ä½œæ—¶ï¼ŒUI å¹¶ä¸æ˜¯å®Œå…¨è£¸éœ²çš„ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€äº›ç§å­æ•°æ®ã€‚

è®©æˆ‘ä»¬ä»å®‰è£…å‡ ä¸ªä¾èµ–é¡¹å¼€å§‹:

```
yarn add -D faker ts-node 
```

è¿™å°†å¼•å…¥ [faker.js](https://www.npmjs.com/package/faker) ï¼Œå®ƒå°†å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆå‡æ•°æ®ï¼Œä»¥åŠå®ƒçš„ [ts-node](https://www.npmjs.com/package/ts-node) ä¾èµ–å…³ç³»ã€‚

æ¥ä¸‹æ¥ï¼Œåœ¨`prisma`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„`seed.ts`æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
import faker from "faker";
import prisma from "../lib/clients/prisma";

async function main() {
  const listOfNewUsers = [...new Array(5)].map(() => {
    return {
      email: faker.internet.email(),
      name: faker.name.findName(),
      image: faker.image.image(),
      tweets: {
        create: {
          body: faker.lorem.sentence(),
        },
      },
    };
  });

  for (let data of listOfNewUsers) {
    const user = await prisma.user.create({
      data,
    });

    console.log(user);
  }
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  }); 
```

æˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°æˆ‘ä»¬çš„`tsconfig.json`æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
{
  "compilerOptions": {
    "target": "es5",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "commonjs",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "baseUrl": ".",
    "paths": {
      "*": [
        "/*"
      ],
      "components/*": [
        "components/*"
      ],
      "pages/*": [
        "pages/*"
      ],
      "types/*": [
        "types/*"
      ],
      "lib/*": [
        "lib/*"
      ],
    },
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx"
  ],
  "exclude": [
    "node_modules"
  ]
} 
```

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ`npx prisma db seed --preview-feature`æ¥ä¸ºæˆ‘ä»¬çš„æ•°æ®åº“æ¤å…¥ä¸€äº›æµ‹è¯•æ•°æ®ã€‚

## æ·»åŠ ååº”æŸ¥è¯¢

[React Query](https://react-query.tanstack.com/) æ˜¯åœ¨ React.js åº”ç”¨ç¨‹åºä¸­è·å–æ•°æ®çš„ä¸€ç§éå¸¸æµè¡Œå’Œé«˜æ•ˆçš„æ–¹å¼ã€‚è®©æˆ‘ä»¬å°† React Query æ·»åŠ åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… React Query:

```
yarn add react-query 
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åœ¨`lib/clients`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`react-query.ts`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// lib/clients/react-query.ts

import { QueryClient } from "react-query";

const queryClient = new QueryClient();

export default queryClient; 
```

æˆ‘ä»¬è¿˜éœ€è¦ç”¨ä»¥ä¸‹å†…å®¹æ›´æ–°æˆ‘ä»¬çš„`pages/_app.tsx`æ–‡ä»¶:

```
// pages/_app.tsx

....

import { QueryClientProvider } from "react-query";
import { Hydrate } from "react-query/hydration";
import queryClient from "../lib/clients/react-query";

const App = ({ Component, pageProps }: AppProps) => {
  return (
    <QueryClientProvider client={queryClient}>
      <Hydrate state={pageProps.dehydratedState}>
        <Head>
          <link rel="shortcut icon" href="/images/favicon.ico" />
        </Head>
        <NextAuthProvider session={pageProps.session}>
          <ChakraProvider>
            <Component {...pageProps} />
          </ChakraProvider>
        </NextAuthProvider>
      </Hydrate>
    </QueryClientProvider>
  );
};

export default App; 
```

è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨ [QueryClientProvider](https://react-query.tanstack.com/reference/QueryClientProvider#_top) åŒ…è£…æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ª`QueryClient`ã€‚

## æŸ¥çœ‹æ¨æ–‡åˆ—è¡¨çš„é€‰é¡¹

è®©æˆ‘ä»¬åœ¨`lib/queries`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`fetch-tweets.ts`çš„æ–°æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
// lib/queries/fetch-tweets.ts

const fetchTweets = async () => {
  const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/tweets`);
  const data = await res.json();

  return data;
};

export default fetchTweets; 
```

è¿™ä¸ªå‡½æ•°å°†è´Ÿè´£è·å–æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰æ¨æ–‡ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨`pages`ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`tweets.tsx`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// pages/tweets.tsx

import fetchTweets from "../lib/queries/fetch-tweets";
import queryClient from "../lib/clients/react-query";
import { GetServerSideProps, InferGetServerSidePropsType } from "next";
import { useSession } from "next-auth/client";
import Head from "next/head";
import React from "react";
import { useQuery } from "react-query";
import { dehydrate } from "react-query/hydration";

const TweetsPage: InferGetServerSidePropsType<
  typeof getServerSideProps
> = ({}) => {
  const { data } = useQuery("tweets", fetchTweets);
  const [session] = useSession();

  if (!session) {
    return <div>Not authenticated.</div>;
  }

  return (
    <>
      <Head>
        <title>All tweets</title>
      </Head>
      {console.log(JSON.stringify(data, null, 2))}
    </>
  );
};

export const getServerSideProps: GetServerSideProps = async ({ req }) => {
  await queryClient.prefetchQuery("tweets", fetchTweets);

  return {
    props: {
      dehydratedState: dehydrate(queryClient),
    },
  };
};

export default TweetsPage; 
```

[getServerSideProps](https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering) æ˜¯ä¸€ä¸ª Next.js å‡½æ•°ï¼Œå¸®åŠ©è·å–æœåŠ¡å™¨ä¸Šçš„æ•°æ®ã€‚è®©æˆ‘ä»¬åœ¨`pages/api/tweets`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`index.ts`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// pages/api/tweets/index.ts

import prisma from "../../../lib/clients/prisma";
import type { NextApiRequest, NextApiResponse } from "next";

export default async (req: NextApiRequest, res: NextApiResponse) => {
  if (req.method === "POST") {
    try {
      const { body } = req;
      const tweet = await prisma.tweet.create({ data: JSON.parse(body) });

      return res.status(200).json(tweet);
    } catch (error) {
      return res.status(422).json(error);
    }
  } else if (req.method === "GET") {
    try {
      const tweets = await prisma.tweet.findMany({
        include: {
          author: true,
        },
        orderBy: [
          {
            createdAt: "desc",
          },
        ],
      });

      return res.status(200).json(tweets);
    } catch (error) {
      return res.status(422).json(error);
    }
  }

  res.end();
}; 
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ­£åœ¨æ£€æŸ¥è¯·æ±‚ã€‚å¦‚æœæ˜¯ä¸€ä¸ª`POST`è¯·æ±‚ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ tweetã€‚å¦‚æœæ˜¯ä¸€ä¸ª`GET`è¯·æ±‚ï¼Œæˆ‘ä»¬å°†å‘é€åŒ…å«ä½œè€…è¯¦ç»†ä¿¡æ¯çš„æ‰€æœ‰æ¨æ–‡ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è®¿é—®[http://localhost:3000/tweets](http://localhost:3000/tweets)ï¼Œæˆ‘ä»¬å°†åœ¨æµè§ˆå™¨çš„æ§åˆ¶å°ä¸­æŸ¥çœ‹æ‰€æœ‰çš„æ¨æ–‡ã€‚

![List of tweets from the API endpoint](../Images/2ebd0e175f5db5e2e07369bdd4400240.png)

è¯·æ³¨æ„ï¼Œç”±äº faker.js ä¼šç”Ÿæˆéšæœºæ•°æ®ï¼Œå› æ­¤æ‚¨åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸Šçœ‹åˆ°çš„è®°å½•ä¼šä¸å±å¹•æˆªå›¾æœ‰æ‰€ä¸åŒã€‚æˆ‘ä»¬ç¨åå°†æ·»åŠ æ·»åŠ æ¨æ–‡çš„é€‰é¡¹ã€‚

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ„å»ºæ˜¾ç¤ºæ¨æ–‡åˆ—è¡¨çš„ç”¨æˆ·ç•Œé¢ã€‚æˆ‘ä»¬å¯ä»¥åœ¨`components/pages/tweets`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`index.tsx`çš„æ–°æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
// components/pages/tweets/index.tsx

import { Box, Grid, Stack } from "@chakra-ui/react";
import Tweet from "./tweet";
import React from "react";
import ITweet from "types/tweet";

const TweetsPageComponent = ({ tweets }) => {
  return (
    <Stack spacing={8}>
      <Grid templateColumns={["1fr", "1fr", "repeat(2, 1fr)"]} gap={8}>
        {tweets?.map((tweet: ITweet) => {
          return (
            <Box key={tweet.id}>
              <Tweet tweet={tweet} />
            </Box>
          );
        })}
      </Grid>
    </Stack>
  );
};

export default TweetsPageComponent; 
```

è®©æˆ‘ä»¬åœ¨åŒä¸€ä¸ªç›®å½•(`components/pages/tweets`)ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`tweet.tsx`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// components/pages/tweets/tweet.tsx

import { Avatar, Box, Stack, Text } from "@chakra-ui/react";
import React, { FC } from "react";

const Tweet: FC = ({ tweet }) => {
  const authorNode = () => {
    return (
      <Stack
        spacing={4}
        isInline
        alignItems="center"
        p={4}
        borderBottomWidth={1}
      >
        <Avatar name={tweet.author.name} src={tweet.author.image} />
        <Stack>
          <Text fontWeight="bold">{tweet.author.name}</Text>
        </Stack>
      </Stack>
    );
  };

  const bodyNode = () => {
    return (
      <Text fontSize="md" p={4}>
        {tweet.body}
      </Text>
    );
  };

  return (
    <Box shadow="lg" rounded="lg">
      <Stack spacing={0}>
        {authorNode()}
        {bodyNode()}
      </Stack>
    </Box>
  );
};

export default Tweet; 
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç”¨ä»¥ä¸‹å†…å®¹æ›´æ–°æˆ‘ä»¬çš„`pages/tweets.tsx`æ–‡ä»¶:

```
// pages/tweets.tsx

....

import Page from "../components/pages/tweets";

....

const TweetsPage: InferGetServerSidePropsType<
  typeof getServerSideProps
> = ({}) => {

....

  return (
    <>
      <Head>
        <title>All tweets</title>
      </Head>
      <Page tweets={data} />
    </>
  );

....

}

.... 
```

è¿™é‡Œï¼Œæˆ‘ä»¬ä¿®æ”¹äº†åº”ç”¨ç¨‹åºçš„ç•Œé¢ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è®¿é—®[http://localhost:3000/tweets](http://localhost:3000/tweets)ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ä»¥ä¸‹å†…å®¹:

![List of tweets](../Images/732d90eafafc5c2c516f0fc5dee1248f.png)

## æ·»åŠ æ–°æ¨æ–‡çš„é€‰é¡¹

è®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–‡æœ¬åŒºåŸŸï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€æ¡æ–°çš„ tweetã€‚ä¸ºæ­¤ï¼Œè®©æˆ‘ä»¬åœ¨`components/pages/tweets`ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`add-new-tweet-form.tsx`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// components/pages/tweets/add-new-tweet-form.tsx

import {
  Box,
  Button,
  FormControl,
  FormLabel,
  Stack,
  Textarea,
} from "@chakra-ui/react";
import saveTweet from "../../../lib/mutations/save-tweet";
import fetchTweets from "../../../lib/queries/fetch-tweets";
import queryClient from "../../../lib/clients/react-query";
import { useSession } from "next-auth/client";
import React, { ChangeEvent, useState } from "react";
import { useMutation, useQuery } from "react-query";

const AddNewTweetForm = () => {
  const [body, setBody] = useState("");
  const [session] = useSession();
  const { refetch } = useQuery("tweets", fetchTweets);
  const mutation = useMutation(saveTweet, {
    onSuccess: async () => {
      await queryClient.invalidateQueries("tweets");

      refetch();
    },
  });

  if (!session) {
    return <div>Not authenticated.</div>;
  }

  const handleSubmit = () => {
    const data = {
      body,
      author: {
        connect: { email: session.user.email },
      },
    };

    mutation.mutate(data);

    if (!mutation.error) {
      setBody("");
    }
  };

  return (
    <Stack spacing={4}>
      <Box p={4} shadow="lg" rounded="lg">
        <Stack spacing={4}>
          <FormControl isRequired>
            <FormLabel htmlFor="body">What's on your mind?</FormLabel>
            <Textarea
              id="body"
              value={body}
              onChange={(e: ChangeEvent<HTMLTextAreaElement>) =>
                setBody(e.currentTarget.value)
              }
            />
          </FormControl>
          <FormControl>
            <Button
              loadingText="Posting..."
              onClick={handleSubmit}
              isDisabled={!body.trim()}
            >
              Post
            </Button>
          </FormControl>
        </Stack>
      </Box>
    </Stack>
  );
};

export default AddNewTweetForm; 
```

[å˜å¼‚](https://react-query.tanstack.com/reference/useMutation#_top)å‡½æ•°è´Ÿè´£å‘æœåŠ¡å™¨å‘å‡º`POST`è¯·æ±‚ã€‚ä¸€æ—¦è¯·æ±‚æˆåŠŸï¼Œå®ƒè¿˜ä¼šé‡æ–°è·å–æ•°æ®ã€‚åŒæ ·ï¼Œè®©æˆ‘ä»¬åœ¨`lib/mutations`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`save-tweet.ts`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// lib/mutations/save-tweet.ts

const saveTweet = async (body: any) => {
  const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/tweets`, {
    method: "POST",
    body: JSON.stringify(body),
  });
  const data = await res.json();

  return data;
};

export default saveTweet; 
```

æˆ‘ä»¬è¿˜éœ€è¦ç”¨ä»¥ä¸‹å†…å®¹ä¿®æ”¹æˆ‘ä»¬çš„`components/pages/tweets/index.tsx`æ–‡ä»¶:

```
// components/pages/tweets/index.tsx

....

import AddNewTweetForm from "./add-new-tweet-form";

....

const TweetsPageComponent = ({ tweets }) => {
  return (
    <Stack spacing={8}>
      <Box>
        <AddNewTweetForm />
      </Box>

      ....

    </Stack>
  );
};

export default TweetsPageComponent; 
```

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è®¿é—®[http://localhost:3000/tweets](http://localhost:3000/tweets)ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤ŸæŸ¥çœ‹æ–‡æœ¬åŒºåŸŸ:

![Textarea to add new tweets](../Images/734ab134a86822ea35f06fa1289e064f.png)

æˆ‘ä»¬ä¹Ÿåº”è¯¥èƒ½å¤Ÿæ·»åŠ ä¸€ä¸ªæ–°çš„æ¨æ–‡ä½¿ç”¨æ–‡æœ¬åŒº(*è¿™ä¸ä¼šæ¨æ–‡åˆ°æ‚¨çš„å®é™…å¸æˆ·ï¼*):

![Add a new tweet](../Images/bb2e5fbc8aa2d9d0801340a3df134574.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªé€‰é¡¹æ¥æŸ¥çœ‹ç”¨æˆ·çš„ä¸ªäººèµ„æ–™ï¼Œå…¶ä¸­åªæ˜¾ç¤ºè¯¥ç”¨æˆ·å‘å¸ƒçš„ tweetsã€‚

## é€‰æ‹©æŸ¥çœ‹ç”¨æˆ·çš„ä¸ªäººèµ„æ–™ï¼Œåªæœ‰ä»–ä»¬çš„æ¨æ–‡

é¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·åˆ—è¡¨çš„é¡µé¢ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨`pages/users`ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`index.tsx`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// pages/users/index.tsx

import { GetServerSideProps, InferGetServerSidePropsType } from "next";
import { useSession } from "next-auth/client";
import Head from "next/head";
import React from "react";
import { useQuery } from "react-query";
import { dehydrate } from "react-query/hydration";
import Page from "../../components/pages/users";
import queryClient from "../../lib/clients/react-query";
import fetchUsers from "../../lib/queries/fetch-users";

const MyAccountPage: InferGetServerSidePropsType<
  typeof getServerSideProps
> = ({}) => {
  const { data } = useQuery("users", fetchUsers);
  const [session] = useSession();

  if (!session) {
    return <div>Not authenticated.</div>;
  }

  return (
    <>
      <Head>
        <title>All users</title>
      </Head>
      <Page users={data} />
    </>
  );
};

export const getServerSideProps: GetServerSideProps = async ({ req }) => {
  await queryClient.prefetchQuery("users", fetchUsers);

  return {
    props: {
      dehydratedState: dehydrate(queryClient),
    },
  };
};

export default MyAccountPage; 
```

æˆ‘ä»¬è¿˜éœ€è¦åœ¨`lib/queries`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`fetch-users.ts`çš„æ–°æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
// lib/queries/fetch-users.ts

const fetchUsers = async () => {
  const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/users`);
  const data = await res.json();

  return data;
};

export default fetchUsers; 
```

è¯¥å‡½æ•°å°†è´Ÿè´£ä» API ç«¯ç‚¹è·å–æ‰€æœ‰ç”¨æˆ·ã€‚æˆ‘ä»¬è¿˜éœ€è¦åœ¨`components/pages/users`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`index.tsx`çš„æ–°æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
// components/pages/users/index.tsx

import { Box, Grid, Stack } from "@chakra-ui/react";
import React from "react";
import User from "./user";

const UsersPageComponent = ({ users }) => {
  return (
    <Stack spacing={8}>
      <Grid templateColumns={["1fr", "1fr", "repeat(2, 1fr)"]} gap={8}>
        {users?.map((user) => {
          return (
            <Box key={user.id}>
              <User user={user} />
            </Box>
          );
        })}
      </Grid>
    </Stack>
  );
};

export default UsersPageComponent; 
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åœ¨åŒä¸€ä¸ªç›®å½•(`components/pages/users`)ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`user.tsx`çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// components/pages/users/user.tsx

import { Avatar, Box, Stack, Text, Button } from "@chakra-ui/react";
import Link from "next/link";
import React, { FC } from "react";

const User: FC = ({ user }) => {
  const authorNode = () => {
    return (
      <Stack
        spacing={4}
        isInline
        alignItems="center"
        p={4}
        borderBottomWidth={1}
      >
        <Avatar name={user.name} src={user.image} />
        <Stack>
          <Text fontWeight="bold">{user.name}</Text>
        </Stack>
      </Stack>
    );
  };

  const bodyNode = () => {
    return (
      <Text fontSize="md" p={4}>
        {user.email}
      </Text>
    );
  };

  const buttonNode = () => {
    return (
      <Box p={4} borderTopWidth={1}>
        <Link href={`/users/${user.id}`}>
          <Button>View profile</Button>
        </Link>
      </Box>
    );
  };

  return (
    <Box shadow="lg" rounded="lg">
      <Stack spacing={0}>
        {authorNode()}
        {bodyNode()}
        {buttonNode()}
      </Stack>
    </Box>
  );
};

export default User; 
```

åœ¨`pages/api/users`ç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ªåä¸º`index.ts`çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// pages/api/users/index.ts

import prisma from "../../../lib/clients/prisma";
import type { NextApiRequest, NextApiResponse } from "next";

export default async (req: NextApiRequest, res: NextApiResponse) => {
  if (req.method === "GET") {
    try {
      const users = await prisma.user.findMany({
        orderBy: [
          {
            createdAt: "desc",
          },
        ],
      });

      return res.status(200).json(users);
    } catch (error) {
      return res.status(422).json(error);
    }
  }

  res.end();
}; 
```

ä¸Šè¿°å‡½æ•°è´Ÿè´£å‘é€æ‰€æœ‰ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è®¿é—®[http://localhost:3000/users](http://localhost:3000/users)ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ç”¨æˆ·åˆ—è¡¨:

![List of users](../Images/ff1edafdba6c2ba3206c6720c02cff86.png)

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºé¡µé¢æ¥æ˜¾ç¤ºå•ä¸ªç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨`pages/users`ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`[id].tsx`çš„æ–°æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// pages/users/[id].tsx

import Page from "../../components/pages/users/[id]";
import queryClient from "../../lib/clients/react-query";
import fetchUser from "../../lib/queries/fetch-user";
import { GetServerSideProps, InferGetServerSidePropsType } from "next";
import { getSession, useSession } from "next-auth/client";
import Head from "next/head";
import React from "react";
import { useQuery } from "react-query";
import { dehydrate } from "react-query/hydration";

const MyAccountPage: InferGetServerSidePropsType<typeof getServerSideProps> = ({
  id,
}) => {
  const { data } = useQuery("user", () => fetchUser(parseInt(id as string)));
  const [session] = useSession();

  if (!session) {
    return <div>Not authenticated.</div>;
  }

  return (
    <>
      <Head>
        <title>{session.user.name}'s profile</title>
      </Head>
      <Page user={data} />
    </>
  );
};

export const getServerSideProps: GetServerSideProps = async ({ query }) => {
  await queryClient.prefetchQuery("user", () =>
    fetchUser(parseInt(query.id as string))
  );

  return {
    props: {
      dehydratedState: dehydrate(queryClient),
      id: query.id,
    },
  };
};

export default MyAccountPage; 
```

`query.id`çš„å€¼å†³å®šäº†å½“å‰ç”¨æˆ·çš„`id`ã€‚æˆ‘ä»¬è¿˜éœ€è¦åœ¨`lib/queries`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`fetch-user.ts`çš„æ–°æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
// lib/queries/fetch-user.ts

const fetchUser = async (userId: number) => {
  const res = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/users/${userId}`
  );
  const data = await res.json();

  return data;
};

export default fetchUser; 
```

ä¸Šé¢çš„å‡½æ•°å°†è´Ÿè´£å‘ API ç«¯ç‚¹å‘å‡º`GET`è¯·æ±‚ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨`components/pages/users/[id]`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`index.tsx`çš„æ–°æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
// components/pages/users/[id]/index.tsx

import { Avatar, Box, Grid, Stack, Text } from "@chakra-ui/react";
import Tweet from "./tweet";
import React, { FC } from "react";

const UsersPageComponent: FC = ({ user }) => {
  const authorNode = () => {
    return (
      <Stack spacing={4} isInline alignItems="center">
        <Avatar name={user?.name} src={user?.image} />
        <Stack>
          <Text fontWeight="bold" fontSize="4xl">
            {user?.name}
          </Text>
        </Stack>
      </Stack>
    );
  };

  return (
    <Stack spacing={8}>
      {authorNode()}
      <Grid templateColumns={["1fr", "1fr", "repeat(2, 1fr)"]} gap={8}>
        {user?.tweets.map((tweet) => {
          return (
            <Box key={tweet.id}>
              <Tweet tweet={tweet} />
            </Box>
          );
        })}
      </Grid>
    </Stack>
  );
};

export default UsersPageComponent; 
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åŒä¸€ä¸ªç›®å½•(`components/pages/users/[id]`)ä¸­å†åˆ›å»ºä¸€ä¸ªåä¸º`tweet.tsx`çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
// components/pages/users/[id]/tweet.tsx

import { Box, Stack, Text } from "@chakra-ui/react";
import React, { FC } from "react";

const Tweet: FC = ({ tweet }) => {
  const bodyNode = () => {
    return (
      <Text fontSize="md" p={4}>
        {tweet.body}
      </Text>
    );
  };

  return (
    <Box shadow="lg" rounded="lg">
      <Stack spacing={0}>{bodyNode()}</Stack>
    </Box>
  );
};

export default Tweet; 
```

æœ€åï¼Œæˆ‘ä»¬éœ€è¦åœ¨`pages/api/users`ç›®å½•ä¸­å†åˆ›å»ºä¸€ä¸ªåä¸º`[id].ts`çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
// pages/api/users/[id].ts

import prisma from "../../../lib/clients/prisma";
import type { NextApiRequest, NextApiResponse } from "next";

export default async (req: NextApiRequest, res: NextApiResponse) => {
  if (req.method === "GET") {
    const userId = parseInt(req.query.id as string);

    try {
      const tweets = await prisma.user.findUnique({
        include: {
          tweets: true,
        },
        where: {
          id: userId,
        },
      });

      return res.status(200).json(tweets);
    } catch (error) {
      console.log(error);

      return res.status(422).json(error);
    }
  }

  res.end();
}; 
```

ä¸Šè¿°å‡½æ•°å°†è´Ÿè´£å‘é€`id`ä¸`req.query.id`ç›¸åŒçš„ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ã€‚æˆ‘ä»¬æŠŠå®ƒè½¬æ¢æˆä¸€ä¸ªæ•°å­—ï¼Œå› ä¸º Prisma è¦æ±‚å®ƒæ˜¯æ•°å­—ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è®¿é—®[http://localhost:3000/users](http://localhost:3000/users)å¹¶ç‚¹å‡»ç”¨æˆ·çš„**æŸ¥çœ‹ç®€ä»‹**æŒ‰é’®ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿçœ‹åˆ°è¯¥ç”¨æˆ·å‘å¸ƒçš„æ¨æ–‡åˆ—è¡¨ã€‚

![Profile of a user with all the tweets posted by that user](../Images/c7d08dc2f33bfedd4773152d41664235.png)

## ç»“è®º

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä¸€èµ·ä½¿ç”¨ Next.js å’Œ Prisma æ¥æ„å»º Twitter çš„å…‹éš†ã€‚æ˜¾ç„¶ï¼ŒTwitter åŒ…å«è®¸å¤šå…¶ä»–åŠŸèƒ½ï¼Œå¦‚è½¬å‘ã€è¯„è®ºå’Œåˆ†äº«æ¯æ¡æ¨æ–‡çš„åŠŸèƒ½ã€‚ç„¶è€Œï¼Œæœ¬æ•™ç¨‹åº”è¯¥ä¸ºæ„å»ºè¿™æ ·çš„ç‰¹æ€§æä¾›åŸºç¡€ã€‚

æˆ‘ä»¬æ„å»ºçš„åº”ç”¨ç¨‹åºçš„ä»£ç å¯ä»¥åœ¨ [GitHub](https://github.com/sitepoint-editors/twitter-clone-using-nextjs-and-prisma) è·å¾—ã€‚è¯·éšæ„æŸ¥çœ‹ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„åº”ç”¨ç¨‹åºçš„ **[ç°åœºæ¼”ç¤º](https://twitter-clone-using-nextjs-and-prisma.vercel.app/)** ã€‚

## åˆ†äº«è¿™ç¯‡æ–‡ç« 