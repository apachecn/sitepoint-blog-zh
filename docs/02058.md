# Java 9 å†…éƒ¨â€”â€”ç‰ˆæœ¬æ¨¡å¼ã€å¤šç‰ˆæœ¬ jar ç­‰ç­‰

> åŸæ–‡:[https://www.sitepoint.com/inside-java-9-part-i/](https://www.sitepoint.com/inside-java-9-part-i/)

ä¸¤ä¸ªæœˆå‰ï¼Œæˆ‘å¸¦æ‚¨æ·±å…¥ Java 9 äº†è§£äº†æ–°çš„è¯­è¨€ç‰¹æ€§å’Œ APIã€‚ä½†æ˜¯æœ‰å¾ˆå¤šä¸œè¥¿æˆ‘ä¸å¾—ä¸å¿½ç•¥ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ä¸€ä¸ªä¸¤éƒ¨åˆ†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†å…³æ³¨æ–°ç‰ˆæœ¬çš„å­—ç¬¦ä¸²å’Œå‘½ä»¤è¡Œè¯­æ³•ã€å¤šç‰ˆæœ¬ jarã€æ”¹è¿›çš„æ—¥å¿—è®°å½•ç­‰ç­‰ã€‚

### ç›®å½• 

*   [JShell](#jshell)
*   [æ–°ç‰ˆæœ¬å­—ç¬¦ä¸²](#newversionstrings)
*   [GNU é£æ ¼çš„å‘½ä»¤è¡Œé€‰é¡¹](#gnustylecommandlineoptions)
*   [æ‰©å±•å’Œæ›´æ–°](#extensionsandupdates)
*   [Unicode](#unicode)
*   [å›¾å½¢](#graphics)
*   [å®‰å…¨](#security)
*   [æ–°çš„ Java è™šæ‹Ÿæœºç‰¹æ€§](#newjavavirtualmachinefeatures)
*   [å¤šé‡Šæ”¾éœ‡å‡»å™¨](#multireleasejars)
*   [ç»Ÿä¸€è®°å½•](#unifiedlogging)
*   [å‘½ä»¤è¡Œæ ‡å¿—éªŒè¯](#commandlineflagvalidation)
*   [é¢„ç•™å †æ ˆåŒº](#reservedstackareas)
*   [ä¸ºå…³é”®éƒ¨åˆ†é¢„ç•™å¸§](#reservingframesforcriticalsections)
*   [ä¾‹å­](#example)
*   [å†…éƒ¨ï¼](#internals)
*   [æ›´ï¼](#butwaitthereis_still_more)
*   [è¯„è®º](#comments)

## JShell

åœ¨ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬è·³è¿‡äº†æ‹¼å›¾ï¼Œå› ä¸ºæ¯ä¸ªäººéƒ½åœ¨è°ˆè®ºå®ƒã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹ JShell åšåŒæ ·çš„äº‹æƒ…ï¼Œå®ƒæ˜¯ Java çš„å…¨æ–° REPLã€‚(ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ è¾“å…¥ Java ä»£ç ï¼Œå®ƒä¼šç«‹å³å¯¹å…¶è¿›è¡Œè¯„ä¼°ã€‚)å¦‚æœä½ è¿˜(ä¸å¤ª)äº†è§£å®ƒï¼Œä½†æƒ³äº†è§£å®ƒï¼Œè¯·è§‚çœ‹ç½—ä¼¯ç‰¹Â·è²å°”å¾·å»å¹´åœ¨æ¯”åˆ©æ—¶ Devoxx å¤§ä¼šä¸Šçš„ç²¾å½©ä»‹ç»ã€‚( [JEP 222](http://openjdk.java.net/jeps/222)

## æ–°ç‰ˆæœ¬å­—ç¬¦ä¸²

ä¸ºäº†ç®€åŒ–è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬ä»ç®€å•çš„ä¸œè¥¿å¼€å§‹:ç‰ˆæœ¬å­—ç¬¦ä¸²ã€‚

è‡³å°‘æˆ‘æ˜¯è¿™æ ·è®¤ä¸ºçš„ï¼Œç›´åˆ°æˆ‘è¯•å›¾ç†è§£ Java çš„ç‰ˆæœ¬ [å‘½åæ¨¡å¼](https://en.wikipedia.org/wiki/Java_Platform,_Standard_Edition#Nomenclature.2C_standards_and_specifications)ã€‚å®ƒä» JDKs 1.0 å’Œ 1.1 å¼€å§‹â€”â€”åˆ°ç›®å‰ä¸ºæ­¢å¾ˆå®¹æ˜“ï¼Œä½†äº‹æƒ…ä»é‚£é‡Œå¼€å§‹èµ°ä¸‹å¡è·¯ã€‚æ˜¾ç„¶ï¼Œç‰ˆæœ¬ 1.2 åˆ° 1.5 åœ¨æŸä¸ªæ—¶å€™è¢«é‡æ–°å‘½åä¸º Java 2ã€‚(è¿˜è®°å¾— *J2SE* ï¼Ÿé‚£æ˜¯åœ¨é‚£é‡Œçš„ *2* ã€‚)éšç€ JDK 1.5 çš„å‡ºç°ï¼Œå¾ˆæ˜æ˜¾è¿™å¹¶æ²¡æœ‰çœŸæ­£å®ç°ï¼Œæ‰€ä»¥ Sun å¼€å§‹ç§°å®ƒä¸º Java 5ã€‚åœ¨ Java 6 å‰åçš„æŸä¸ªæ—¶å€™ï¼ŒJava 2 çš„æ•´ä¸ªæ¦‚å¿µè¢«æ‚„æ‚„åœ°åŸ‹è‘¬äº†ï¼Œä»é‚£ä»¥åäº‹æƒ…å˜å¾—æ˜æœ—äº†ä¸€äº›â€”â€”æˆ‘ä»¬ç®€å•åœ°ç§°ä¹‹ä¸ºâ€œJava Xâ€ã€‚(æ‚¨çŸ¥é“å—ï¼ŒJava 7 ä¹‹å‰çš„æ‰€æœ‰ Java ç‰ˆæœ¬éƒ½æœ‰å¾ˆé…·çš„é¡¹ç›®åç§°ï¼Œå¦‚ *Tiger* å’Œ *Mustang* ï¼Ÿ)

JVM æŠ¥å‘Šçš„ç‰ˆæœ¬å­—ç¬¦ä¸²æ²¡æœ‰è¢«æ”¹åŠ¨â€”â€”å®ƒä»¬æ€»æ˜¯æŠ¥å‘Š`1.x...`ã€‚ç°åœ¨ï¼Œæœ‰äº† [JEP 223](http://openjdk.java.net/jeps/223) ï¼Œç‰ˆæœ¬å­—ç¬¦ä¸²å’Œå‘½åæ¨¡å¼ä¸€è‡´äº†ã€‚å¦‚æœæ‚¨æ£€æŸ¥ç›¸å…³çš„ç³»ç»Ÿå±æ€§(å‚è§[æ¼”ç¤º](https://github.com/CodeFX-org/demo-java-9/blob/master/src/org/codefx/demo/java9/internal/version/VersionSchema.java)ï¼Œæ‚¨å°†å¾—åˆ°ä»¥ä¸‹è¾“å‡º:

```
java.version: 9-ea
java.runtime.version: 9-ea+138-jigsaw-nightly-h5561-20161003
java.vm.version: 9-ea+138-jigsaw-nightly-h5561-20161003
java.specification.version: 9
java.vm.specification.version: 9 
```

è¿™å¹¶æ²¡æœ‰æä¾›å¤ªå¤šçš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨æ—©æœŸçš„è®¿é—®æ„å»ºä¸Šè¿è¡Œçš„ã€‚å°†æ¥ï¼Œ`java.version`å°†æŠ¥å‘Šç±»ä¼¼äº`9.1.2`çš„å­—ç¬¦ä¸²ï¼Œå®ƒä»¬éµå¾ªæ¨¡å¼`$MAJOR.$MINOR.$SECURITY`:

*   æ ‡å¿—ç€ Oracle è®¡åˆ’æ¯ä¸¤åˆ°ä¸‰å¹´å‘å¸ƒä¸€æ¬¡çš„ä¸»è¦ç‰ˆæœ¬ã€‚
*   æ ‡è®°è¾ƒå°ç‰ˆæœ¬çš„é”™è¯¯ä¿®å¤å’Œå…¶ä»–å®šæœŸå‘å¸ƒçš„ç»†èŠ‚â€”â€”å½“æ–°çš„ä¸»è¦ç‰ˆæœ¬å‘å¸ƒæ—¶ï¼Œå®ƒé‡ç½®ä¸ºé›¶ã€‚
*   `$SECURITY`çœŸçš„å¾ˆæœ‰è¶£â€”â€”å®ƒéšç€æ¯ä¸ªâ€œåŒ…å«å…³é”®ä¿®å¤ï¼ŒåŒ…æ‹¬æé«˜å®‰å…¨æ€§æ‰€å¿…éœ€çš„ä¿®å¤â€çš„ç‰ˆæœ¬è€Œè¢«å–æ¶ˆï¼Œå¹¶ä¸”å½“`$MINOR`å¢åŠ æ—¶**ä¸ä¼šé‡ç½®**ã€‚

ä¸ºäº†ä¸éœ€è¦è§£æé‚£ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å¾—åˆ°äº† [`Version`](http://download.java.net/java/jdk9/docs/api/java/lang/Runtime.Version.html) ï¼Œä¸€ä¸ªå¾ˆå¥½çš„å°ç±»ä¸ºæˆ‘ä»¬åšäº†è¿™ä»¶äº‹ã€‚

```
Version version = Runtime.version();
System.out.println("Reported by runtime: " + version);
switch (version.major()) {
    case 9:
        System.out.println("Modularity!");
        break;
    case 10:
        System.out.println("Value Types!");
        break;
} 
```

## GNU é£æ ¼çš„å‘½ä»¤è¡Œé€‰é¡¹

å½“æ¶‰åŠåˆ°å‘½ä»¤è¡Œé€‰é¡¹çš„è¯­æ³•æ—¶ï¼ŒJava å·¥å…·æœ‰å¾ˆå¤šç‰¹æ€§:

*   æœ‰äº›äººç”¨å•ä¸ªç ´æŠ˜å·è¡¨ç¤ºé•¿ç‰ˆæœ¬(`-classpath`)ï¼Œæœ‰äº›äººç”¨ä¸¤ä¸ªç ´æŠ˜å·(`--gzip`)
*   æœ‰äº›å•è¯ç”¨ç ´æŠ˜å·(`--no-gzip`)åˆ†å¼€ï¼Œæœ‰äº›åˆ™ä¸ç”¨(å†æ¬¡ç”¨`-classpath`)
*   æœ‰äº›æœ‰å•å­—æ¯å½¢å¼(`-d`)ï¼Œæœ‰äº›æœ‰ä¸¤ä¸ªå­—æ¯å½¢å¼(`-cp`)ï¼Œè¯´çœŸçš„é‚£ä¸ªé€‰é¡¹æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼)
*   æœ‰äº›ç”¨ç­‰å·(`-D<name>=<value>`)èµ‹å€¼ï¼Œæœ‰äº›éœ€è¦ç©ºæ ¼(æˆ‘ç”šè‡³ä¸ä¼šâ€¦)

ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨ Linux å’Œå…¶ä»–åŸºäº GNU çš„ç³»ç»Ÿä¸Šï¼Œå‡ ä¹æ‰€æœ‰å·¥å…·çš„é€‰é¡¹éƒ½ä½¿ç”¨ç›¸åŒçš„è¯­æ³•:

*   ä¸¤ä¸ªç ´æŠ˜å·ä»£è¡¨é•¿ç‰ˆæœ¬
*   å•è¯ç”¨ç ´æŠ˜å·éš”å¼€
*   ç¼©å†™ä½¿ç”¨å•ä¸ªç ´æŠ˜å·ï¼Œç”±å•ä¸ªå­—æ¯ç»„æˆ

Java 9 å¤§èƒ†åœ°ä¿®æ”¹äº†æ‰€æœ‰å‘½ä»¤è¡Œé€‰é¡¹æ¥åŒ¹é…è¿™äº›è§„åˆ™ï¼Œä»è€Œç ´åäº†æ‰€æœ‰è„šæœ¬ï¼ä¸ï¼Œåªæ˜¯å¼€ç©ç¬‘â€¦ğŸ˜ä½†æ˜¯ JEP 293 å»ºç«‹äº†ä¸€ä¸ªåæ˜ å’Œé€‚åº”è¿™äº›è§„åˆ™çš„æŒ‡å¯¼æ–¹é’ˆï¼Œæ–°çš„é€‰æ‹©å°†ä¼šéµå¾ªå®ƒã€‚æ—§çš„é€‰é¡¹å¯èƒ½ä¼šåœ¨æŸä¸ªæ—¶å€™å‘æ›´æ¸…æ™°çš„è¯­æ³•è¿ç§»ï¼Œä½†è¿™ä¸æ˜¯ Java 9 çš„ä¸€éƒ¨åˆ†ã€‚JEP åŒ…å«äº†å¾ˆå¤šç»†èŠ‚å’Œä¾‹å­â€”â€”è¯»ä¸€è¯»å§ã€‚

## æ‰©å±•å’Œæ›´æ–°

Java 9 é™„å¸¦äº†è®¸å¤šæ‰©å±•æˆ–æ›´æ–°ç°æœ‰åŠŸèƒ½çš„ jepã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬ï¼ŒæŒ‰ä¸»é¢˜æ’åºï¼Œæœ‰äº›æ˜¯æ‘˜è¦ï¼Œæœ‰äº›æ›´è¯¦ç»†ã€‚

### ç»Ÿä¸€ç 

è™½ç„¶ Java æœ¬èº«å¯ä»¥ç”¨ UTF-16 ç¼–å†™(æ˜¯çš„ï¼Œæ‚¨çš„ä»£ç å¯ä»¥æ˜¾ç¤ºè¡¨æƒ…ç¬¦å·)ï¼Œä½†å±æ€§æ–‡ä»¶è¿‡å»ä»…é™äº ISO-8859-1ã€‚å‡è®¾æ‚¨æœ‰è¿™æ ·ä¸€ä¸ª`config.properties`æ–‡ä»¶:

```
money = â‚¬ / \u20AC 
```

é‚£ä¹ˆç”¨ Java 8 è®¿é—®è¿™ä¸ªæ–‡ä»¶ä¼šäº§ç”Ÿ:

```
money = Ã¢â–¯Â¬ / â‚¬ 
```

éšç€ [JEP 226](http://openjdk.java.net/jeps/226) çš„å‡ºç°ï¼Œé‚£äº›æ—¶ä»£ç»ˆäºç»“æŸäº†ï¼Œä¸å†éœ€è¦ [Unicode è½¬ä¹‰](https://www.sitepoint.com/java-unicode-mysterious-compile-error/)ã€‚åœ¨ Java 9 ä¸Šè¿è¡Œç›¸åŒçš„è®¿é—®ä»£ç æ˜¾ç¤ºäº†æˆ‘ä»¬é¢„æœŸçš„ç»“æœ:

```
money = â‚¬ / â‚¬ 
```

([å®Œæ•´ç¤ºä¾‹](https://github.com/CodeFX-org/demo-java-9/blob/master/resources/config.properties)ç”šè‡³è¿˜æœ‰ä¸€ä¸ªğŸ˜ä½†æ˜¯æˆ‘ä»¬çš„ä»£ç è§å…‰ç¬”ä¸èƒ½å¾ˆå¥½åœ°å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚)

æ³¨æ„ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥è®¿é—®å±æ€§æ–‡ä»¶ï¼Œåªæœ‰é€šè¿‡`PropertyResourceBundle`çš„æ–¹æ³•å¾—åˆ°äº†æ›´æ–°ã€‚ç¼–ç æ˜¯å¦‚ä½•ç¡®å®šçš„ä»¥åŠå¦‚ä½•é…ç½®çš„ï¼Œåœ¨ JavaDoc çš„ API æ³¨é‡Šä¸­æœ‰è¯¦ç»†è¯´æ˜ã€‚ä¸è¿‡ï¼Œç¼ºçœå€¼æ˜¯åˆç†çš„ï¼Œå¹¶ä½¿ APIâ€œåªé€‚ç”¨äºâ€å¸¸è§æƒ…å†µ:

```
try (InputStream propertyFile = new FileInputStream("config.properties")) {
    PropertyResourceBundle properties = new PropertyResourceBundle(propertyFile);
    properties.getKeys().asIterator().forEachRemaining(key -> {
        String value = properties.getString(key);
        System.out.println(key + " = " + value);
    });
} catch (IOException e) {
    e.printStackTrace();
} 
```

ä½ ä¼šåœ¨[çš„æ¼”ç¤º](https://github.com/CodeFX-org/demo-java-9/blob/master/src/org/codefx/demo/java9/internal/resources/ResourceFileEncoding.java)ä¸­æ‰¾åˆ°è¿™æ®µä»£ç ä»¥åŠä¸`Properties` API çš„å¹¶åˆ—å…³ç³»ã€‚å¦‚æœæ‚¨å°è¯•åœ¨ Java 8 ä¸Šè¿è¡Œå®ƒè¿›è¡Œæ¯”è¾ƒï¼Œæ‚¨ä¼šå‘ç° Java 9 ä¸ºé‚£äº›ä»åœ¨ä½¿ç”¨å¤è€çš„`Enumeration`çš„è´«ç©·å¼€å‘äººå‘˜åšäº†ä¸€ä¸ªæ¼‚äº®çš„å° API æ”¹å˜ã€‚

å…¶ä»– Unicode ç›¸å…³æ–°é—»ï¼ŒJava 9 æ”¯æŒ **Unicode 8.0** ã€‚è€¶ï¼( [JEP 227](http://openjdk.java.net/jeps/227) ï¼Œ [JEP 267](http://openjdk.java.net/jeps/267) )

### åˆ¶å›¾æ³•

**TIFF** å›¾åƒç°åœ¨è¢«å›¾åƒ I/O æ¡†æ¶æ”¯æŒ(åœ¨`javax.imageio`ä¸­)ã€‚ [Java é«˜çº§æˆåƒ(JAI)é¡¹ç›®](http://www.oracle.com/technetwork/java/iio-141084.html)å®ç°äº†è¯¥æ ¼å¼çš„è¯»å–å™¨å’Œå†™å…¥å™¨ï¼Œå®ƒä»¬ç°åœ¨å·²ç»æ ‡å‡†åŒ–å¹¶ç§»å…¥`javax.imageio.plugins.tiff`ã€‚( [JEP 262](http://openjdk.java.net/jeps/262) )

è§†ç½‘è†œé£æ ¼çš„ HiDPI å±å¹•ç»™æ¡Œé¢ç”¨æˆ·ç•Œé¢å¸¦æ¥äº†ç‹¬ç‰¹çš„æŒ‘æˆ˜ã€‚Java å·²ç»åœ¨ Mac ä¸Šè§£å†³äº†è¿™äº›é—®é¢˜ï¼Œç°åœ¨åˆåœ¨ Linux å’Œ Windows ä¸Šè·Ÿè¿›ã€‚æœ‰äº†è¿™ä¸ªâ€œçª—å£å’Œ GUI ç»„ä»¶åº”è¯¥å…·æœ‰åŸºäºå¹³å°å»ºè®®çš„é€‚å½“å¤§å°ï¼Œæ–‡æœ¬åº”è¯¥ä¿æŒæ¸…æ™°ï¼Œå°½ç®¡ HiDPI è®¾ç½®æŒ‡ç¤ºä»»ä½•é»˜è®¤ç¼©æ”¾ï¼Œå›¾æ ‡å’Œå›¾åƒåº”è¯¥å¹³æ»‘ï¼Œå¹¶ä¸”æœ€å¥½å…·æœ‰é€‚åˆæ˜¾ç¤ºå™¨åƒç´ å¯†åº¦çš„ç»†èŠ‚ã€‚â€( [JEP 263](http://openjdk.java.net/jeps/263)

åœ¨ Linux ä¸Šï¼ŒJava æ¡Œé¢ä¸‰å·¨å¤´(AWTã€Swing å’Œ JavaFX)ç°åœ¨å¯ä»¥ä½¿ç”¨ **GTK 3** ã€‚ç›®å‰ï¼ŒJVM å°†é»˜è®¤ä½¿ç”¨ GTK 2ï¼Œå¹¶ä¸”åªæœ‰åœ¨æ–°çš„ç³»ç»Ÿå±æ€§`jdk.gtk.version`æˆ–è€…â€œäº’æ“ä½œæ€§éœ€è¦ GTK3ï¼Œå¹¶ä¸”è¿™ä¸ªéœ€æ±‚å¯ä»¥åœ¨è¶³å¤Ÿæ—©çš„æ—¶å€™è¢«æ£€æµ‹åˆ°â€æŒ‡ç¤ºçš„æƒ…å†µä¸‹æ‰ä½¿ç”¨ GTK 3ã€‚( [JEP 283](http://openjdk.java.net/jeps/283) )

JavaFX ç”¨çš„æ˜¯è¿‡æ—¶çš„ [**GStreamer**](https://gstreamer.freedesktop.org/) ç‰ˆæœ¬ï¼Œæ›´æ–°åˆ° 1.4.4ã€‚è¿™å°†æé«˜ JavaFX é‡æ”¾åª’ä½“çš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚( [JEP 257](http://openjdk.java.net/jeps/257) )

[**HarfBuzz**](http://harfbuzz.org/) ä¸ºæ–° [OpenType](http://www.microsoft.com/typography/otspec/) å¸ƒå±€å¼•æ“ï¼Œå–ä»£ [ICU](http://userguide.icu-project.org/layoutengine) ï¼Œåœäº§ã€‚( [JEP 258](http://openjdk.java.net/jeps/258) )

### å®‰å…¨æ€§

å®ç°äº† **SHA-3** å“ˆå¸Œç®—æ³• SHA3-224ã€SHA3-256ã€SHA3-384 å’Œ SHA3-512ã€‚å®ƒä»¬å¯ä»¥é€šè¿‡ [`MessageDigest` API](http://download.java.net/java/jdk9/docs/api/java/security/MessageDigest.html) ä½¿ç”¨ã€‚( [JEP 287](http://openjdk.java.net/jeps/287) )

å½“ä½¿ç”¨`SecureRandom`(åœ¨ä»»ä½• Java ç‰ˆæœ¬ä¸Š)æ—¶ï¼Œä½ è¦ä¹ˆå¾—åˆ°ä¸€ä¸ªåŸºäºä½ çš„æ“ä½œç³»ç»Ÿçš„æœ¬åœ°ç†µæºçš„æœ¬åœ°å®ç°ï¼Œè¦ä¹ˆå¾—åˆ°ä¸€ä¸ªçº¯ Java ç‰ˆæœ¬[ã€‚åè€…â€œä½¿ç”¨äº†ä¸€ç§æ›´è€çš„åŸºäº SHA1 çš„ RNG å®ç°ï¼Œå®ƒæ²¡æœ‰è¢«æ‰¹å‡†çš„ **DRBG** ã€ç¡®å®šæ€§éšæœºä½ç”Ÿæˆå™¨ã€‘æœºåˆ¶æ‰€ä½¿ç”¨çš„ç®—æ³•å¼ºå¤§ã€‚â€ç”±äºè¾ƒè€ä½†ç‰¹åˆ«æ˜¯åµŒå…¥å¼ç³»ç»Ÿä¾èµ–äº Java å˜ä½“ï¼Œå…¶å®‰å…¨æ€§é€šè¿‡å®æ–½](https://docs.oracle.com/javase/8/docs/api/java/security/SecureRandom.html) [NIST 800-90Ar1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-90Ar1.pdf) ä¸­æè¿°çš„ DRBG æœºåˆ¶å¾—åˆ°äº†å¢å¼ºã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ`SecureRandom`çš„ API å¾—åˆ°äº†æ”¹è¿›ï¼Œå…è®¸å°†å‚æ•°ä¼ é€’ç»™ DRGB å’Œæœªæ¥çš„ç®—æ³•( [JEP 273](http://openjdk.java.net/jeps/273) ):

```
Instantiation instantiation = DrbgParameters.instantiation(128, RESEED_ONLY, null);
SecureRandom random = SecureRandom.getInstance("DRBG", instantiation);

byte[] bytes = new byte[20];
random.nextBytes(bytes); 
```

![Published by Ali Bindawood under CC-BY-ND 2.0](../Images/9ae83b5bc41f7224f7d4c7f3fbca7f7e.png)

[å‘å¸ƒ](https://www.flickr.com/photos/aliab55/15174758674/ "Source on Flickr")ç”±[é˜¿é‡ŒÂ·å®¾è¾¾ä¼å¾·](https://www.flickr.com/photos/aliab55/ "Author on Flickr")åœ¨ [CC-BY-ND 2.0](https://creativecommons.org/licenses/by-nd/2.0/ "Link to Licence") ä¸‹å‘å¸ƒ

## æ–°çš„ Java è™šæ‹Ÿæœºç‰¹æ€§

ä¸ºæˆ‘ä»¬åšæ‰€æœ‰å·¥ä½œçš„æœºå™¨â€”â€”æˆ‘æƒ³çŸ¥é“ï¼Œæœ‰ä¸€å¤©ä¼šå‡ºç°å—ï¼Ÿå®ƒä»¥å‡ ä¸ªæ–°åŠŸèƒ½çš„å½¢å¼å¾—åˆ°äº†ä¸€äº›å–œçˆ±ï¼Œæ‰€ä»¥ä¹Ÿè®¸æˆ‘ä»¬å†è®©å®ƒå¹³é™å‡ å¹´ã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ï¼Œä½œä¸ºä¸€ä¸ªäººï¼Œæ¬¢è¿æˆ‘ä»¬æ–°çš„ ~~[æ˜†è™«](https://www.youtube.com/watch?v=8lcUHQYhPTE)~~ æœºå™¨éœ¸ä¸»ã€‚

### å¤šé‡Šæ”¾ç½

æœ‰æ—¶ä½ å¯èƒ½æƒ³å†™ä»£ç æ¥åŒºåˆ†ä½ è¿è¡Œçš„ Java ç‰ˆæœ¬â€”â€”å¯¹ Java 8 åš*è¿™ä¸ª*ï¼Œå¯¹ Java 9 åš*é‚£ä¸ª*ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™è¿˜æœ‰ç‚¹æ£˜æ‰‹ï¼Œä½†æ˜¯ Java 9 è§£å†³äº†è¿™ä¸ªéš¾é¢˜çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ã€‚Java å¹³å°çš„æ‰€æœ‰ç›¸å…³éƒ¨åˆ†ç°åœ¨éƒ½åˆ›å»ºå¹¶ç†è§£å¤šç‰ˆæœ¬ jarï¼Œè¿™äº› jar åŒ…å«ä¸åŒ Java ç‰ˆæœ¬çš„ç›¸åŒç±»å‹çš„ä¸åŒç‰ˆæœ¬ã€‚

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­:

1.  æˆ‘åˆ›å»ºäº†ä¸‰ä¸ªç±»ï¼ŒJava 8 çš„`Main`ã€`VersionDependent`å’Œ Java 9 çš„`VersionDependent`ï¼Œå‰è€…æ‰“å°è°ƒç”¨åè€…çš„ç»“æœï¼Œåè€…ç®€å•åœ°è¿”å›â€œJava X versionâ€ï¼Œå…¶ä¸­ *X* è¦ä¹ˆæ˜¯ 8ï¼Œè¦ä¹ˆæ˜¯ 9ã€‚

2.  æ¥ä¸‹æ¥ï¼Œæˆ‘æŠŠ`Main`å’Œ`VersionDependent`(é’ˆå¯¹ Java 8)ç¼–è¯‘æˆä¸€ä¸ªæ–‡ä»¶å¤¹`out-mr/java8`ï¼ŒæŠŠ`VersionDependent` (Java 9)ç¼–è¯‘æˆ`out-mr/java9`ã€‚

3.  æœ‰è¶£çš„æ˜¯å¦‚ä½•åŒ…è£…å®ƒä»¬ã€‚ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸¤æ¬¡`VersionDependent.class`çš„`mr.jar`(æ¯æ¬¡æ¥è‡ªä¸€ä¸ª`out-mr/java-x`æ–‡ä»¶å¤¹),å…¶ç»“æ„ä½¿å¾—`java`é€‰æ‹©æ­£ç¡®çš„ç±»:

    ```
    jar9 --create --file out-mr/mr.jar -C out-mr/java-8 . \
        --release 9 -C out-mr/java-9 . 
    ```

4.  å®é™…ä¸Šï¼Œç”¨`java -cp out-mr/mr.jar ...Main`è¿è¡Œå®ƒåœ¨ç”¨ 8 è¿è¡Œæ—¶ä¼šè¿”å›â€œJava 8 ç‰ˆæœ¬â€,åœ¨ç”¨ 9 è¿è¡Œæ—¶ä¼šè¿”å›â€œJava 9 ç‰ˆæœ¬â€ã€‚

è¿™æ˜¯ç½å­ä»å†…éƒ¨çœ‹èµ·æ¥çš„æ ·å­:

```
â”” org
    â”” codefx ... (moar folders)
        â”œ Main.class
        â”” VersionDependent.class
â”” META-INF
    â”” versions
        â”” 9
            â”” org
                â”” codefx ... (moar folders)
                    â”” VersionDependent.class 
```

è¿™æ ·ï¼ŒJava ç‰ˆæœ¬ 8 å’Œæ›´è€çš„ç‰ˆæœ¬å°†ç®€å•åœ°ä½¿ç”¨`org`ä¸­çš„ç±»ï¼Œä½†æ˜¯æ–°ç‰ˆæœ¬å¯ä»¥ç”¨å³è¾¹`META-INF/versions`å­æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹è¦†ç›–å…¶ä¸­çš„ä¸€äº›ã€‚å¹²å‡€åˆ©è½ã€‚

### ç»Ÿä¸€æ—¥å¿—è®°å½•

è°ƒè¯• JVMï¼Œä¹Ÿè®¸æ˜¯ä¸ºäº†è§£é‡Šåº”ç”¨ç¨‹åºå´©æºƒæˆ–å¯»æ‰¾æ€§èƒ½æ¼æ´ï¼Œå·²ç»è¶³å¤Ÿå¤æ‚äº†ã€‚ä¸åŒå­ç³»ç»Ÿçš„ä¸åŒæ—¥å¿—è®°å½•é€‰é¡¹å¹¶æ²¡æœ‰è®©è¿™å˜å¾—æ›´å®¹æ˜“ã€‚æ„Ÿè°¢æ°æ™®æ–¯ [158](http://openjdk.java.net/jeps/158) å’Œ [271](http://openjdk.java.net/jeps/271) è¿™å°†å¾ˆå¿«æˆä¸ºè¿‡å»ã€‚å®ƒæä¾›äº†ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œé€‰é¡¹`-Xlog`(ç°åœ¨ä¸åº”è¯¥æ˜¯`--log`å—ï¼Ÿ)å¯ç”¨äºå°†æ—¥å¿—è®°å½•å®šä¹‰åˆ°éå¸¸è¯¦ç»†çš„çº§åˆ«ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯ç”¨çš„è®¾ç½®:

*   æ¯æ¡æ¶ˆæ¯å¯ä»¥æœ‰ä¸€å †æ ‡ç­¾ï¼Œè¿™å–å†³äºåˆ›å»ºå®ƒçš„å­ç³»ç»Ÿå’Œå®ƒå½“æ—¶åœ¨åšä»€ä¹ˆâ€”â€”ä¸€äº›ä¾‹å­æ˜¯`gc`ã€`modules`æˆ–`os`ã€‚å¯ä»¥é€‰æ‹©å•ä¸ªæ ‡ç­¾æ¥åº”ç”¨å…¶ä»–è®¾ç½®ã€‚
*   å½“ç„¶ï¼Œæ¶ˆæ¯æœ‰çº§åˆ«(`error`ã€`warning`ã€`info`ã€`debug`ã€`trace`ã€`develop`)ï¼Œå¯ä»¥æ ¹æ®çº§åˆ«è¿›è¡Œç­›é€‰ã€‚
*   è¾“å‡ºå¯ä»¥å®šä¹‰ä¸º`stdout`ã€`stderr`æˆ–ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥è®¾ç½®ä¸ºæ—¥å¿—æ–‡ä»¶å¾ªç¯ã€‚
*   ç„¶åæ˜¯*è£…é¥°*â€”â€”æ¯æ¡æ¶ˆæ¯é™„å¸¦çš„æœ‰ç”¨ä¿¡æ¯(pidã€æ­£å¸¸è¿è¡Œæ—¶é—´ã€â€¦ã€æŠ€æœ¯ä¸Šçš„æ ‡ç­¾å’Œçº§åˆ«ä¹Ÿæ˜¯è£…é¥°)ã€‚å®ƒä»¬å¯ä»¥åŒ…å«åœ¨è¾“å‡ºä¸­ã€‚

æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥è¢«å›ºå®šåœ¨ä¸€ä¸ª`-Xlog`é€‰é¡¹ä¸­ã€‚è®©æˆ‘ä»¬ä»ç®€å•åœ°è®°å½•å‡ ä¸ªæ ‡è®°å¼€å§‹:

```
java9 -cp out-mr/mr.jar -Xlog:os,modules,gc ...Main

[0.002s][info][os] SafePoint Polling address: 0x00007feea4c96000
[0.002s][info][os] Memory Serialize Page address: 0x00007feea4c94000
[0.002s][info][os] HotSpot is running with glibc 2.22, NPTL 2.22
[0.009s][info][gc] Using G1
Java 9 version 
```

Mmhï¼Œæ¨¡å—çœŸçš„ä»€ä¹ˆéƒ½æ²¡æœ‰å—ï¼Ÿè®©æˆ‘ä»¬å°†è¯¥æ ‡ç­¾è®¾ä¸º`debug`(å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œçº§åˆ«é»˜è®¤ä¸º`info`):

```
java9 -cp out-mr/mr.jar -Xlog:os,modules=debug,gc org.codefx.demo.java9.internal.multi_release.Main

[0.002s][info][os] SafePoint Polling address: 0x00007f3054a22000
[0.002s][info][os] Memory Serialize Page address: 0x00007f3054a20000
[0.002s][info][os] HotSpot is running with glibc 2.22, NPTL 2.22
[0.009s][info][gc] Using G1
[0.059s][debug][modules] set_bootloader_unnamed_module(): recording unnamed module for boot loader
[0.063s][debug][modules] define_javabase_module(): Definition of module: java.base, version: 9-ea, location: jrt:/java.base, package #: 159
[... snip ... many, many more module messages ... ] 
```

å¤ªå¤šäº†ã€‚ä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ª:

```
[0.079s][info][modules,startuptime] Phase2 initialization, 0.0366552 secs 
```

å“ï¼Œé‚£æ˜¯`info`ï¼ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰å‡ºç°ï¼Ÿï¼å› ä¸ºå®ƒæœ‰ä¸¤ä¸ªæ ‡ç­¾ï¼Œä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œå¦‚æœå‘½ä»¤è¡Œä¸Šå®šä¹‰çš„æ ‡ç­¾ä¸æ¶ˆæ¯æ ‡ç­¾ä¸­çš„*ä¸€ä¸ª*åŒ¹é…æ˜¯ä¸å¤Ÿçš„â€”â€”å®ƒä»¬å¿…é¡»ä¸æ¶ˆæ¯æ ‡ç­¾ä¸­çš„*å…¨éƒ¨*åŒ¹é…ã€‚æˆ‘ä»¬å¯ä»¥å°†åŒ¹é…å™¨æ‰©å±•åˆ°`modules+startuptime`æˆ–è€…ä½¿ç”¨é€šé…ç¬¦:

```
java9 -cp out-mr/mr.jar -Xlog:os,modules*,gc* ...Main

[0.002s][info][os] SafePoint Polling address: 0x00007f9c7f307000
[0.002s][info][os] Memory Serialize Page address: 0x00007f9c7f305000
[0.003s][info][os] HotSpot is running with glibc 2.22, NPTL 2.22
[0.007s][info][gc,heap] Heap region size: 1M
[0.009s][info][gc     ] Using G1
[0.009s][info][gc,heap,coops] Heap address: 0x00000006c6200000, size: 3998 MB, Compressed Oops mode: Zero based, Oop shift amount: 3
[0.077s][info][modules,startuptime] Phase2 initialization, 0.0367418 secs
Java 9 version
[0.090s][info][gc,heap,exit       ] Heap
[0.090s][info][gc,heap,exit       ]  garbage-first heap   total 256000K, used 2048K [0x00000006c6200000, 0x00000006c63007d0, 0x00000007c0000000)
[0.090s][info][gc,heap,exit       ]   region size 1024K, 3 young (3072K), 0 survivors (0K)
[0.090s][info][gc,heap,exit       ]  Metaspace       used 4225K, capacity 4532K, committed 4864K, reserved 1056768K
[0.090s][info][gc,heap,exit       ]   class space    used 414K, capacity 428K, committed 512K, reserved 1048576K 
```

çœ‹ï¼Œç”šè‡³åƒåœ¾æ”¶é›†å™¨ä¹Ÿæœ‰è¯è¦è¯´â€”â€”åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯å…³äºé€€å‡ºå’Œå †ã€‚

è¿™åªæ˜¯è¡¨é¢ç°è±¡ï¼Œè¿˜æœ‰æ›´å¤šçš„é€‰é¡¹å¯ä»¥è°ƒæ•´ã€‚JEP åœ¨è§£é‡Šè¿™ä¸€åˆ‡æ–¹é¢åšå¾—å¾ˆå¥½ï¼ŒåŒ…æ‹¬ä¾‹å­ã€‚

æˆ‘æåˆ°äº†è¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³è¿™ç§æ”¹è¿›å¹¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„é—®é¢˜ã€‚åŸå› æ˜¯ï¼ŒJEPs ä¸“æ³¨äºæä¾›åŸºç¡€è®¾æ–½å’Œé‡æ–°è·¯ç”±ä¸€äº›(è®¸å¤šï¼Ÿè‚¯å®šæ˜¯æ‰€æœ‰çš„ GC æ¶ˆæ¯)ï¼Œä½†ä¸ä¸€å®šæ˜¯æ‰€æœ‰çš„ã€‚è™½ç„¶æˆ‘æ‰¾ä¸åˆ°ä»»ä½•å…¶ä»–ä¸ä½¿ç”¨æ–°æœºåˆ¶çš„æ—¥å¿—è®°å½•ï¼Œä½†å®ƒå¾ˆå¯èƒ½å·²ç»å­˜åœ¨äº†ã€‚

### å‘½ä»¤è¡Œæ ‡å¿—éªŒè¯

è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰è¶£çš„äº‹å®:Java 8 VM ç›´åˆ°å®é™…éœ€è¦æ—¶æ‰éªŒè¯å‘½ä»¤è¡Œæ ‡å¿—çš„å€¼ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™åœ¨åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½å·²ç»å¾ˆæ™šäº†ï¼Œæˆ‘å¯ä»¥çœ‹åˆ°éšä¹‹è€Œæ¥çš„å´©æºƒå¯èƒ½ä¼šå¸¦æ¥ä¸€äº›æŒ«æŠ˜ã€‚è®©æˆ‘ä»¬ä¸¾è¿™ä¸ªä¾‹å­:

```
java -cp out-mr/mr.jar -XX:BlockLayoutMinDiamondPercentage=120 ...Main 
```

è™½ç„¶æˆ‘ä¸çŸ¥é“`BlockLayoutMinDiamondPercentage`æ˜¯åšä»€ä¹ˆçš„(ä¹Ÿæ‡’å¾—å»æŸ¥)ï¼Œä½†çœ‹èµ·æ¥`120`å¹¶ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ç™¾åˆ†æ¯”ã€‚Java 8 å¹¶æ²¡æœ‰å› æ­¤è€Œå—åˆ°å½±å“ï¼Œå¹¶æ„‰å¿«åœ°æ‰§è¡Œäº†æˆ‘ä»¬çš„ JARï¼ŒæˆåŠŸåœ°è¿è¡Œäº†æ•´ä¸ªä»£ç â€”â€”æ˜¾ç„¶ï¼Œè¿™ä¸ªå€¼åœ¨è¿™ä¸ªç¨‹åºè¿è¡Œä¸­æ˜¯ä¸éœ€è¦çš„ã€‚æˆ–è€…ä¹Ÿè®¸`120`ç»ˆç©¶æ˜¯ä¸€ä¸ªæœ‰æ•ˆå€¼ï¼Ÿä½†æ˜¯ Java 9 ä¸è¿™ä¹ˆè®¤ä¸º:

```
java9 -cp out-mr/mr.jar -XX:BlockLayoutMinDiamondPercentage=120 ...Main

intx BlockLayoutMinDiamondPercentage=120 is outside the allowed range [ 0 ... 100 ]
Improperly specified VM option 'BlockLayoutMinDiamondPercentage=120'
Error: Could not create the Java Virtual Machine.
Error: A fatal exception has occurred. Program will exit. 
```

æ›´å¥½â€¦å› ä¸ºå¤šäºäº† [JEP 245](http://openjdk.java.net/jeps/245) Java 9 æœ‰èƒ½åŠ›åœ¨å¯åŠ¨æ—¶éªŒè¯æ‰€æœ‰çš„è¾“å…¥æ ‡å¿—ã€‚ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå®ƒè¿˜æ‰“å°äº†è§£é‡Šæ€§çš„é”™è¯¯æ¶ˆæ¯ã€‚

### ä¿ç•™å †æ ˆåŒºåŸŸ

å¦‚æœä¸€ä¸ªçº¿ç¨‹ç”¨å®Œäº†å †æ ˆç©ºé—´ï¼Œå®ƒä¼šæŠ›å‡ºä¸€ä¸ª`StackOverflowError`ã€‚åœ¨ç”¨æˆ·ä»£ç ä¸­ï¼Œè¿™é€šå¸¸æ˜¯åº”ç”¨ç¨‹åºçš„æ­»åˆ‘åˆ¤å†³ï¼Œæ‰€ä»¥é€šå¸¸æ²¡æœ‰ç†ç”±å»æ‹…å¿ƒã€‚ä½†æ˜¯åœ¨åº“ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨ Java çš„æ ¸å¿ƒä¸­ï¼Œå³ä½¿åœ¨å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œä¿è¯æŸäº›ä¸å˜é‡ä¹Ÿæ˜¯æœ‰æ„ä¹‰çš„ã€‚

ä»¥ [`ReentrantLock`](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/ReentrantLock.html) ä¸ºä¾‹ï¼Œå…¶ä¸­ä¸€ä¸ª`StackOverflowError`åœ¨é”™è¯¯çš„æ—¶åˆ»ä¼šç ´åé”çš„çŠ¶æ€ï¼Œä½¿å…¶æ°¸è¿œæ— æ³•å†æ¬¡è§£é”ã€‚å¦‚æœåº”ç”¨ç¨‹åºå†³å®šæ•æ‰é”™è¯¯å¹¶ç»§ç»­è¿è¡Œï¼Œé‚£ä¹ˆé”ä¼šæ­»é”æ‰€æœ‰ç›¸å…³çš„çº¿ç¨‹ã€‚ä¸å¤ªå¥½ã€‚

#### ä¸ºå…³é”®éƒ¨åˆ†é¢„ç•™å¸§

[JEP 270](http://openjdk.java.net/jeps/270) å¢åŠ æ–°æ³¨è§£`@ReservedStackAccess`ã€‚æœ‰äº†å®ƒï¼Œæ–¹æ³•å¯ä»¥å°†è‡ªå·±æ ‡è¯†ä¸ºå…³é”®éƒ¨åˆ†ï¼Œå¦‚æœç³»ç»Ÿä¸æƒ³ä»¥æŸåçš„çŠ¶æ€ç»“æŸï¼Œå°±éœ€è¦å®Œæˆè¿™äº›å…³é”®éƒ¨åˆ†ã€‚JVM å…³äºæ‰§è¡Œå †æ ˆçš„è¡Œä¸ºä¹Ÿç›¸åº”åœ°æ”¹å˜äº†ã€‚å®ƒä¿ç•™äº†ä¸€äº›é¢å¤–çš„å †æ ˆç©ºé—´ï¼Œå¹¶ä¸”æ¯å½“ä¸€ä¸ª`StackOverflowError`å‘ç”Ÿæ—¶ï¼Œå®ƒæ£€æŸ¥ä¸€ä¸ª`@ReservedStackAccess`æ³¨é‡Šçš„æ–¹æ³•æ˜¯å¦åœ¨å †æ ˆä¸­ã€‚å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œè¿™ä¸ªç©ºé—´å°±å¯ä¾›å®ƒä½¿ç”¨ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥åšä¸€äº›é¢å¤–çš„å·¥ä½œã€‚ä¸€æ—¦å®Œæˆï¼Œå¼‚å¸¸è¿˜æ˜¯ä¼šè¢«æŠ›å‡ºã€‚

è¿™æ„å‘³ç€ä½¿ç”¨æ³¨é‡Šå¹¶ä¸ç¥å¥‡â€”â€”å¼‚å¸¸ä¼šè¢«æŠ›å‡ºï¼Œçº¿ç¨‹å¾ˆå¯èƒ½ä¼šåƒæ²¡æœ‰æ³¨é‡Šä¸€æ ·æ­»å»ã€‚åªæœ‰å½“ä¸€æ®µä»£ç éœ€è¦å®Œæˆ*å¹¶ä¸”*èƒ½å¤Ÿä¿è¯åœ¨ä¸ºæ­¤ç›®çš„ä¿ç•™çš„ç©ºé—´ä¸­å®Œæˆæ—¶ï¼Œä½¿ç”¨å®ƒæ‰æœ‰æ„ä¹‰ã€‚

å †æ ˆä¸­é¢„ç•™äº†å¤šå°‘ç©ºé—´ï¼Ÿç›®å‰ï¼Œå®ƒé»˜è®¤ä¸ºå•ä¸ªå†…å­˜é¡µï¼Œå¹¶ä¸”â€œå®éªŒè¡¨æ˜ï¼Œè¿™è¶³ä»¥è¦†ç›–åˆ°ç›®å‰ä¸ºæ­¢å·²ç»æ³¨é‡Šçš„`java.util.concurrent`é”çš„å…³é”®éƒ¨åˆ†ã€‚â€

#### ä¾‹å­

ç¼–å†™ä¸€ä¸ªä¾‹å­å¹¶ä¸ç®€å•ï¼Œå› ä¸ºæˆ‘å‘ç°å¾ˆéš¾ä»¥ä¸€ç§å¯æ§çš„æ–¹å¼æŒç»­æº¢å‡ºå †æ ˆï¼ŒåŒæ—¶ä»ç„¶åˆ©ç”¨ä¿ç•™çš„ç©ºé—´åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ã€‚åœ¨æ¼”ç¤ºé¡¹ç›®ä¸­ï¼Œä½ ä¼šå‘ç°[æ˜¯æˆ‘åœ¨é‚£ä¸ª](https://github.com/CodeFX-org/demo-java-9/blob/master/src/org/codefx/demo/java9/internal/stack/ReservingStackAreas.java)ä¸Šçš„æœ€ä½³å°è¯•ï¼Œä½†æˆ‘ä¸æƒ³åœ¨è¿™ç¯‡æ–‡ç« ä¸­å‘ä½ ä»‹ç»å®ƒã€‚ç›¸åï¼Œæˆ‘å°†å±•ç¤ºä¸€äº›ä»£ç ï¼Œå®ƒä»¬æ€»æ˜¯ä»¥ä¸å—æ§åˆ¶çš„æ–¹å¼æº¢å‡ºå †æ ˆï¼Œå¹¶ä¸”æ²¡æœ‰å¯¹ä¿ç•™ç©ºé—´åšä»»ä½•æœ‰ç”¨çš„äº‹æƒ…ã€‚

```
int depth;

@ReservedStackAccess
private void determineDepthWithReservedStack() {
    determineDepth();
}

private void determineDepth() {
    depth = 0;
    try {
        recurseToDetermineMaxDepth();
    } catch (StackOverflowError err) { }
    System.out.printf("Depth: %d%n", depth);
}

private void recurseToDetermineMaxDepth() {
    depth++;
    recurseToDetermineMaxDepth();
} 
```

ä»åº•éƒ¨åˆ°é¡¶éƒ¨ï¼Œæ‚¨ä¼šçœ‹åˆ°ä¸€ä¸ªæ–¹æ³•æ— é™é€’å½’å¹¶é€’å¢`depth`å­—æ®µï¼Œå¦ä¸€ä¸ªæ–¹æ³•åŒ…è£…å®ƒï¼Œæ•æ‰å¼‚å¸¸å¹¶æ‰“å°ç»“æœæ·±åº¦ï¼Œæœ€åç¬¬ä¸‰ä¸ªæ–¹æ³•è¯·æ±‚è®¿é—®ä¿ç•™çš„å †æ ˆåŒºåŸŸã€‚æˆ‘æ²¡æœ‰å¾ˆå¥½åœ°åˆ©ç”¨ä¿ç•™çš„å †æ ˆåŒºåŸŸï¼Œå› ä¸ºæˆ‘åªæ˜¯ç”¨æ›´å¤šçš„é€’å½’è°ƒç”¨æ¥è€—å°½å®ƒã€‚è¿™æ„å‘³ç€è°ƒç”¨`determineDepth`æˆ–`determineDepthWithReservedStack`å°†æœ€ç»ˆå¯¼è‡´å †æ ˆæº¢å‡ºï¼Œè§¦å‘æ‰“å°è°ƒç”¨æ¬¡æ•°ã€‚ä½†æ˜¯è¾“å‡ºåº”è¯¥ä¸åŒï¼Œäº‹å®ä¸Š:

```
DEPTH USING REGULAR STACK
Depth: 21392

DEPTH USING RESERVED STACK
Java HotSpot(TM) 64-Bit Server VM warning: Potentially dangerous stack overflow in ReservedStackAccess annotated method org.codefx.demo.java9.internal.stack.ReservingStackAreas.determineDepthWithReservedStack()V [1]
Depth: 59544 
```

å°½ç®¡ç»“æœéå¸¸ä¸ç¨³å®šã€‚æˆ‘å‡è®¾æœ‰å¾ˆå¤šå…¶ä»–æœºåˆ¶åœ¨èµ·ä½œç”¨ï¼Œè¿™ä¸ªæ¼”ç¤ºéå¸¸ç²—ç³™ã€‚

#### å†…éƒ¨ï¼

å¦‚æœä½ ç°åœ¨æµå£æ°´ï¼Œè¯·æ³¨æ„è¿™æ˜¯å†…éƒ¨ APIã€‚ä¸ºäº†è¯´æœç¼–è¯‘å™¨è®©ä½ è®¿é—®æ³¨é‡Šï¼Œä½ å¿…é¡»ç”¨`--add-exports java.base/jdk.internal.vm.annotation=<module>`è¿›å…¥åŸºæœ¬æ¨¡å—ï¼Œå…¶ä¸­`<module>`æˆ–è€…æ˜¯ä½ çš„æ¨¡å—å(å¦‚æœä½ å·²ç»è¿™ä¹ˆåšäº†)æˆ–è€…æ˜¯`ALL-UNNAMED`ã€‚ä½†æ˜¯ JVM ä»ç„¶ä¼šå¿½ç•¥æ³¨é‡Šï¼Œé™¤éæ‚¨ç”¨`-XX:-RestrictReservedStack`å…³é—­å¯¹ç‰¹æƒä»£ç çš„é™åˆ¶ã€‚

çœ‹çœ‹æ¼”ç¤ºé¡¹ç›®ä¸­çš„`compile.sh`å’Œ`run.sh`æ˜¯å¦‚ä½•ç»“åˆåœ¨ä¸€èµ·çš„ã€‚

## ä½†æ˜¯ç­‰ç­‰ï¼Œè¿˜æœ‰*è¿˜æœ‰*æ›´ï¼

æ˜¯çš„ï¼Œè¿˜æœ‰æ›´å¤šï¼Œè¿™æ¬¡ä½ ä¸ç”¨ç­‰ä¸¤ä¸ªæœˆäº†ï¼Œæˆ‘ä¿è¯ã€‚ç¬¬äºŒéƒ¨åˆ†åº”è¯¥åœ¨ä¸‹å‘¨çš„æŸä¸ªæ—¶é—´å®Œæˆï¼Œå°†é›†ä¸­åœ¨æ€§èƒ½æå‡å’Œç¼–è¯‘å™¨æ”¹è¿›ä¸Šã€‚æˆ‘ç¡®ä¿¡æ—¶äº‹é€šè®¯ä¼šç»™ä½ ä¸€ä¸ªå…ˆç¹ä¸ºå¿«çš„æœºä¼šï¼Œæ‰€ä»¥å¦‚æœä½ å¥½å¥‡çš„è¯[è®¢é˜…](https://go.sitepoint.com/h/y/43CDB766C5398A3B)(åœ¨ä¸–ç•Œåè°ƒæ—¶é—´å‘¨äº”æ™šä¸Šä¹‹å‰)æˆ–è€…åœ¨ Medium ä¸Šå…³æ³¨æˆ‘ä»¬ï¼Œæˆ–è€…[æˆ‘](https://medium.com/@nipa)æˆ–è€…[ç«™ç‚¹ç‚¹](https://medium.com/sitepoint)(æˆ–è€…ä¸¤è€…éƒ½æœ‰)ï¼Œå®ƒä»¬å°†åœ¨ä¸‹å‘¨å‡ºç°ã€‚

å¦‚æœæ‚¨å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·å¸®åŠ©æˆ‘ä»¬ä¼ æ’­æ¶ˆæ¯ï¼Œå¹¶å‘Šè¯‰æ‚¨çš„æœ‹å‹æˆ–åŒäº‹ï¼

## åˆ†äº«è¿™ç¯‡æ–‡ç« 