# åˆ©ç”¨ Websockets å’ŒæœåŠ¡å™¨å‘é€çš„äº‹ä»¶æ„å»ºå®æ—¶åº”ç”¨

> åŸæ–‡:[https://www . site point . com/real-time-apps-web sockets-server-sent-events/](https://www.sitepoint.com/real-time-apps-websockets-server-sent-events/)

*è¿™ç¯‡æ–‡ç« ç”±[å…‹é›·æ ¼Â·æ¯”å°”çº³](https://www.sitepoint.com/author/cbilner)å’Œ[ä¸¹Â·æ™®æ—æ–¯](https://www.sitepoint.com/author/dprince/)è¿›è¡Œäº†åŒè¡Œè¯„å®¡ã€‚æ„Ÿè°¢ SitePoint çš„æ‰€æœ‰åŒè¡Œè¯„å®¡å‘˜ä½¿ SitePoint çš„å†…å®¹å°½å¯èƒ½åšåˆ°æœ€å¥½ï¼*

ç¼–å†™å¯Œäº’è”ç½‘åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†æ˜¯å¯¹æ•°æ®å˜åŒ–åšå‡ºååº”ã€‚è€ƒè™‘ä¸€ä¸‹ Guillermo Rauch çš„ä¸‹é¢è¿™æ®µè¯ï¼Œæ‘˜è‡ªä»– 2014 å¹´åœ¨å·´è¥¿çš„æ¼”è®²[Rich Web Applications çš„ 7 ä¸ªåŸåˆ™](https://www.youtube.com/watch?v=p2F-128e3sI)ã€‚

å½“æœåŠ¡å™¨ä¸Šçš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ— éœ€è¯¢é—®å°±è®©å®¢æˆ·ç«¯çŸ¥é“ã€‚è¿™æ˜¯æ€§èƒ½æ”¹è¿›çš„ä¸€ç§å½¢å¼ï¼Œå°†ç”¨æˆ·ä»æ‰‹åŠ¨åˆ·æ–°æ“ä½œ(F5ï¼Œæ‹‰è‡³åˆ·æ–°)ä¸­è§£æ”¾å‡ºæ¥ã€‚æ–°çš„æŒ‘æˆ˜:(é‡æ–°)è¿æ¥ç®¡ç†ï¼ŒçŠ¶æ€åè°ƒã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹å¦‚ä½•ä½¿ç”¨åŸå§‹çš„ [WebSocket](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket) API ä»¥åŠé²œä¸ºäººçŸ¥çš„[event source](https://developer.mozilla.org/en-US/docs/Web/API/EventSource)for[server-sent events(SSE)](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events)æ¥æ„å»ºè‡ªæˆ‘æ›´æ–°çš„â€œå®æ—¶â€UIã€‚å¦‚æœä½ ä¸ç¡®å®šæˆ‘è¯´çš„æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæˆ‘æ¨èä½ çœ‹ä¸Šé¢æåˆ°çš„è§†é¢‘ï¼Œæˆ–è€…é˜…è¯»[ç›¸åº”çš„åšæ–‡](http://rauchg.com/2014/7-principles-of-rich-web-applications/#react-to-data-changes)ã€‚

## ç®€å²

è¿‡å»æˆ‘ä»¬å¿…é¡»æ¨¡æ‹ŸæœåŠ¡å™¨æ¨é€ï¼Œæœ€è‘—åçš„æ–¹æ³•æ˜¯[é•¿è½®è¯¢](https://en.wikipedia.org/wiki/Push_technology#Long_Polling)ã€‚è¿™æ¶‰åŠåˆ°å®¢æˆ·ç«¯å‘å‡ºä¸€ä¸ªå¾ˆé•¿çš„è¯·æ±‚ï¼Œè¯¥è¯·æ±‚å°†ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œç›´åˆ°æœåŠ¡å™¨å‡†å¤‡å¥½æ¨é€æ¶ˆæ¯ã€‚æ”¶åˆ°æ¶ˆæ¯åï¼Œè¯·æ±‚å°†è¢«å…³é—­ï¼Œå¹¶å‘å‡ºæ–°çš„è¯·æ±‚ã€‚å…¶ä»–è§£å†³æ–¹æ¡ˆåŒ…æ‹¬`<iframe>`é»‘å®¢å’Œ Flashã€‚è¿™å¹¶ä¸ç†æƒ³ã€‚

ç„¶åï¼Œåœ¨ 2006 å¹´ï¼ŒOpera ä» WHATWG Web Applications 1.0 è§„èŒƒä¸­å¼•å…¥äº†[æœåŠ¡å™¨å‘é€äº‹ä»¶](https://en.wikipedia.org/wiki/Server-sent_events) (SSE)ã€‚
SSE å…è®¸ä½ ä»ä½ çš„ç½‘ç»œæœåŠ¡å™¨å‘è®¿é—®è€…çš„æµè§ˆå™¨è¿ç»­ä¼ è¾“äº‹ä»¶ã€‚å…¶ä»–æµè§ˆå™¨ç´§éšå…¶åï¼Œåœ¨ 2011 å¹´å¼€å§‹å®ç° SSEï¼Œä½œä¸º HTML5 è§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚

2011 å¹´ï¼Œå½“ [WebSocket åè®®](https://en.wikipedia.org/wiki/WebSocket)è¢«æ ‡å‡†åŒ–åï¼Œäº‹æƒ…å˜å¾—è¶Šæ¥è¶Šæœ‰è¶£ã€‚WebSockets å…è®¸æ‚¨æ‰“å¼€å®¢æˆ·æœºå’ŒæœåŠ¡å™¨ä¹‹é—´çš„åŒå‘æŒä¹…è¿æ¥ï¼Œä½¿æ‚¨èƒ½å¤Ÿåœ¨æœåŠ¡å™¨ä¸Šçš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶å°†æ•°æ®æ¨å›åˆ°å®¢æˆ·æœºï¼Œè€Œæ— éœ€å®¢æˆ·æœºè¯·æ±‚å®ƒã€‚è¿™å¯¹äºå…·æœ‰å¤§é‡å¹¶å‘è¿æ¥å’Œå¿«é€Ÿå˜åŒ–å†…å®¹çš„åº”ç”¨ç¨‹åº(ä¾‹å¦‚å¤šäººåœ¨çº¿æ¸¸æˆ)çš„å“åº”èƒ½åŠ›éå¸¸é‡è¦ã€‚ç„¶è€Œï¼Œç›´åˆ° 2014 å¹´[socket . io](http://socket.io)â€”â€”å°† WebSockets æ¨å‘å¤§ä¼—çš„æœ€çªå‡ºçš„åŠªåŠ›â€”â€”å‘å¸ƒåï¼Œæˆ‘ä»¬æ‰çœ‹åˆ°æ›´å¤šå…³äºå®æ—¶é€šä¿¡çš„å®éªŒã€‚

å¯ä»¥è¯´ï¼Œä»Šå¤©æˆ‘ä»¬æœ‰æ›´ç®€å•çš„æ–¹æ³•æ¥å®ç°æœåŠ¡å™¨æ¨é€ï¼Œè€Œä¸éœ€è¦å‘å‡ºæ–°çš„è¯·æ±‚æˆ–è€…ä¾èµ–äºéæ ‡å‡†æ’ä»¶ã€‚è¿™äº›æŠ€æœ¯ä½¿æ‚¨èƒ½å¤Ÿåœ¨æœåŠ¡å™¨ä¸Šå‘ç”Ÿäº‹æƒ…æ—¶å°†æ•°æ®æµå›å®¢æˆ·æœºã€‚

## websocket

ç†è§£æŒä¹…è¿æ¥å…è®¸æ‚¨åšä»€ä¹ˆçš„æœ€ç®€å•çš„æ–¹æ³•æ˜¯è¿è¡Œä¸€ä¸ªå·¥ä½œæ¼”ç¤ºï¼Œæˆ‘ä»¬ç¨åå°†é€æ­¥ä»‹ç»ä»£ç ï¼Œä½†ç°åœ¨ä¸‹è½½æ¼”ç¤ºå¹¶è¿›è¡Œæ¼”ç¤ºã€‚

### æ¼”ç¤º

```
git clone https://github.com/sitepoint-editors/websocket-demo.git
cd websocket-demo
npm install
npm start 
```

åœ¨å¤šä¸ªæµè§ˆå™¨çª—å£ä¸­æ‰“å¼€ [http://localhost:8080/](http://localhost:8080/) ï¼Œè§‚å¯Ÿæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¸­çš„æ—¥å¿—ï¼ŒæŸ¥çœ‹æ¥å›çš„æ¶ˆæ¯ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ³¨æ„åœ¨æœåŠ¡å™¨ä¸Šæ¥æ”¶ä¸€æ¡æ¶ˆæ¯æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œä»¥åŠå…¶ä½™è¿æ¥çš„å®¢æˆ·ç«¯æ„è¯†åˆ°è¿™ä¸€å˜åŒ–æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚

### å®¢æˆ·

`WebSocket`æ„é€ å™¨é€šè¿‡`ws`æˆ–`wss`(å®‰å…¨)åè®®å¯åŠ¨ä¸æœåŠ¡å™¨çš„è¿æ¥ã€‚å®ƒæœ‰ä¸€ä¸ª`send`æ–¹æ³•å°†æ•°æ®æ¨é€åˆ°æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥æä¾›ä¸€ä¸ª`onmessage`å¤„ç†ç¨‹åºä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªæ³¨é‡Šç¤ºä¾‹ï¼Œæ˜¾ç¤ºäº†æ‰€æœ‰é‡è¦äº‹ä»¶:

```
// Open a connection
var socket = new WebSocket('ws://localhost:8081/');

// When a connection is made
socket.onopen = function() {
  console.log('Opened connection ğŸ‰');

  // send data to the server
  var json = JSON.stringify({ message: 'Hello ğŸ‘‹' });
  socket.send(json);
}

// When data is received
socket.onmessage = function(event) {
  console.log(event.data);
}

// A connection could not be made
socket.onerror = function(event) {
  console.log(event);
}

// A connection was closed
socket.onclose = function(code, reason) {
  console.log(code, reason);
}

// Close the connection when the window is closed
window.addEventListener('beforeunload', function() {
  socket.close();
}); 
```

### æœåŠ¡å™¨

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ WebSockets æœ€æµè¡Œçš„èŠ‚ç‚¹åº“æ˜¯ [ws](https://www.npmjs.com/package/ws) ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥ç®€åŒ–äº‹æƒ…ï¼Œå› ä¸º[ç¼–å†™ WebSocket æœåŠ¡å™¨](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers)ä¸æ˜¯ä¸€é¡¹ç®€å•çš„ä»»åŠ¡ã€‚

```
var WSS = require('ws').Server;

// Start the server
var wss = new WSS({ port: 8081 });

// When a connection is established
wss.on('connection', function(socket) {
  console.log('Opened connection ğŸ‰');

  // Send data back to the client
  var json = JSON.stringify({ message: 'Gotcha' });
  socket.send(json);

  // When data is received
  socket.on('message', function(message) {
    console.log('Received: ' + message);
  });

  // The connection was closed
  socket.on('close', function() {
    console.log('Closed Connection ğŸ˜±');
  });

});

// Every three seconds broadcast "{ message: 'Hello hello!' }" to all connected clients
var broadcast = function() {
  var json = JSON.stringify({
    message: 'Hello hello!'
  });

  // wss.clients is an array of all connected clients
  wss.clients.forEach(function each(client) {
    client.send(json);
    console.log('Sent: ' + json);
  });
}
setInterval(broadcast, 3000); 
```

`ws`åŒ…ä½¿å¾—æ„å»ºä¸€ä¸ªæ”¯æŒ WebSocket çš„æœåŠ¡å™¨å˜å¾—ç®€å•ï¼Œä½†æ˜¯å¦‚æœä½ åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œä½ åº”è¯¥ä»”ç»†é˜…è¯»ä¸€ä¸‹ [WebSocket Security](https://devcenter.heroku.com/articles/websocket-security) ã€‚

### æµè§ˆå™¨å…¼å®¹æ€§

æµè§ˆå™¨å¯¹ WebSockets çš„æ”¯æŒæ˜¯ç¨³å›ºçš„ï¼ŒOpera Mini å’Œ IE9 åŠä»¥ä¸‹ç‰ˆæœ¬é™¤å¤–ï¼Œæœ‰ä¸€ä¸ª [polyfill](https://github.com/gimite/web-socket-js) å¯ç”¨äºåœ¨å¹•åä½¿ç”¨ Flash çš„æ—§ IEã€‚

æˆ‘å¯ä»¥ä½¿ç”¨ WebSockets å—ï¼Ÿcaniuse.com ä¸»è¦æµè§ˆå™¨å¯¹ websockets åŠŸèƒ½çš„æ”¯æŒæ•°æ®ã€‚